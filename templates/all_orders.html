{% extends "base.html" %}

{% block title %}All Orders - H&O Parcel Scans{% endblock %}

{% block extra_styles %}{% endblock %}

{% block content %}
    <div class="page-header">
      <h2>All Orders</h2>
      <div class="sync-status" id="syncStatus">
        {% if sync_status.last_sync_at %}
          Last synced: {{ sync_status.last_sync_at.strftime('%Y-%m-%d %H:%M') if sync_status.last_sync_at else 'Never' }}
          ({{ sync_status.last_sync_count or 0 }} orders)
        {% else %}
          Not synced yet
        {% endif %}
      </div>
    </div>

    <!-- Filter and Search Bar -->
    <div class="filter-bar">
      <div class="filter-group">
        <a href="{{ url_for('all_orders', filter='unfulfilled', q=search_query) }}"
           class="filter-btn {% if fulfillment_filter == 'unfulfilled' %}active{% endif %}">
          Unfulfilled
        </a>
        <a href="{{ url_for('all_orders', filter='fulfilled', q=search_query) }}"
           class="filter-btn {% if fulfillment_filter == 'fulfilled' %}active{% endif %}">
          Fulfilled
        </a>
        <a href="{{ url_for('all_orders', filter='all', q=search_query) }}"
           class="filter-btn {% if fulfillment_filter == 'all' %}active{% endif %}">
          All
        </a>
      </div>

      <form action="{{ url_for('all_orders') }}" method="get" class="search-box">
        <input type="hidden" name="filter" value="{{ fulfillment_filter }}">
        <input type="text" name="q" placeholder="Search order #, name, email, tracking..."
               value="{{ search_query }}">
      </form>

      <button type="button" class="btn-refresh" id="refreshBtn" onclick="syncOrders(false)">
        <span class="refresh-icon">&#x21bb;</span>
        Refresh
      </button>

      <button type="button" class="btn-refresh" id="fullSyncBtn" onclick="syncOrders(true)"
              style="background: #e8f5e9; border-color: #c8e6c9;">
        <span class="refresh-icon">&#x21bb;</span>
        Full Sync (90 days)
      </button>
    </div>

    <!-- Advanced Filters -->
    <div class="advanced-filters" id="advancedFilters">
      <div class="filter-header">
        <h4>Advanced Filters</h4>
        <button type="button" class="filter-toggle" onclick="toggleFilters()">
          <span id="filterToggleText">{{ 'Hide' if filters else 'Show' }}</span>
        </button>
      </div>
      <div id="filterContent" style="{{ '' if filters else 'display: none;' }}">
        <form action="{{ url_for('all_orders') }}" method="get" id="advancedFilterForm">
          <input type="hidden" name="filter" value="{{ fulfillment_filter }}">
          <input type="hidden" name="q" value="{{ search_query }}">
          <input type="hidden" name="filters" id="filtersJson" value="{{ filters_json or '' }}">

          <!-- Filter Rows Container -->
          <div id="filterRowsContainer">
            {% if filters %}
              {% for f in filters %}
              <div class="filter-row" data-filter-index="{{ loop.index0 }}">
                <select class="filter-field">
                  <option value="">-- Select Field --</option>
                  <optgroup label="Order Items">
                    <option value="item_name" {{ 'selected' if f.field == 'item_name' else '' }}>Item Name</option>
                    <option value="item_options" {{ 'selected' if f.field == 'item_options' else '' }}>Item Options (customizations)</option>
                    <option value="item_sku" {{ 'selected' if f.field == 'item_sku' else '' }}>Item SKU</option>
                  </optgroup>
                  <optgroup label="Customer">
                    <option value="customer_name" {{ 'selected' if f.field == 'customer_name' else '' }}>Customer Name</option>
                    <option value="customer_email" {{ 'selected' if f.field == 'customer_email' else '' }}>Customer Email</option>
                  </optgroup>
                  <optgroup label="Shipping Address">
                    <option value="ship_country" {{ 'selected' if f.field == 'ship_country' else '' }}>Country</option>
                    <option value="ship_province" {{ 'selected' if f.field == 'ship_province' else '' }}>Province/State</option>
                    <option value="ship_city" {{ 'selected' if f.field == 'ship_city' else '' }}>City</option>
                    <option value="ship_address1" {{ 'selected' if f.field == 'ship_address1' else '' }}>Address Line 1</option>
                    <option value="ship_address2" {{ 'selected' if f.field == 'ship_address2' else '' }}>Address Line 2</option>
                    <option value="ship_zip" {{ 'selected' if f.field == 'ship_zip' else '' }}>Postal/ZIP Code</option>
                  </optgroup>
                  <optgroup label="Order">
                    <option value="order_note" {{ 'selected' if f.field == 'order_note' else '' }}>Order Notes</option>
                    <option value="is_international" {{ 'selected' if f.field == 'is_international' else '' }}>International (non-Canada)</option>
                    <option value="weight_over" {{ 'selected' if f.field == 'weight_over' else '' }}>Weight Over (grams)</option>
                    <option value="weight_under" {{ 'selected' if f.field == 'weight_under' else '' }}>Weight Under (grams)</option>
                  </optgroup>
                </select>

                <select class="filter-condition">
                  <option value="contains" {{ 'selected' if f.condition == 'contains' else '' }}>Contains</option>
                  <option value="not_contains" {{ 'selected' if f.condition == 'not_contains' else '' }}>Does not contain</option>
                  <option value="equals" {{ 'selected' if f.condition == 'equals' else '' }}>Equals</option>
                  <option value="not_equals" {{ 'selected' if f.condition == 'not_equals' else '' }}>Does not equal</option>
                </select>

                <input type="text" class="filter-value" placeholder="Enter value (comma-separate for multiple)"
                       value="{{ f.value or '' }}">

                <button type="button" class="btn-remove-filter" onclick="removeFilterRow(this)">&times;</button>
              </div>
              {% endfor %}
            {% endif %}
            <!-- Empty row template for new filters -->
            <div class="filter-row" id="newFilterRow">
              <select class="filter-field">
                <option value="">-- Select Field --</option>
                <optgroup label="Order Items">
                  <option value="item_name">Item Name</option>
                  <option value="item_options">Item Options (customizations)</option>
                  <option value="item_sku">Item SKU</option>
                </optgroup>
                <optgroup label="Customer">
                  <option value="customer_name">Customer Name</option>
                  <option value="customer_email">Customer Email</option>
                </optgroup>
                <optgroup label="Shipping Address">
                  <option value="ship_country">Country</option>
                  <option value="ship_province">Province/State</option>
                  <option value="ship_city">City</option>
                  <option value="ship_address1">Address Line 1</option>
                  <option value="ship_address2">Address Line 2</option>
                  <option value="ship_zip">Postal/ZIP Code</option>
                </optgroup>
                <optgroup label="Order">
                  <option value="order_note">Order Notes</option>
                  <option value="is_international">International (non-Canada)</option>
                  <option value="weight_over">Weight Over (grams)</option>
                  <option value="weight_under">Weight Under (grams)</option>
                </optgroup>
              </select>

              <select class="filter-condition">
                <option value="contains">Contains</option>
                <option value="not_contains">Does not contain</option>
                <option value="equals">Equals</option>
                <option value="not_equals">Does not equal</option>
              </select>

              <input type="text" class="filter-value" placeholder="Enter value (comma-separate for multiple)">

              <button type="button" class="btn-add-filter" onclick="addFilterRow()">+</button>
            </div>
          </div>

          <div class="filter-actions" style="margin-top: 12px;">
            <button type="button" class="btn-apply-filters" onclick="applyFilters()">Apply Filters</button>
            <button type="button" class="btn-clear-filters" onclick="clearAdvancedFilters()">Clear All</button>
          </div>
        </form>

        {% if filters %}
        <div class="active-filters">
          {% set field_labels = {
            'item_name': 'Item Name',
            'item_options': 'Item Options',
            'item_sku': 'SKU',
            'customer_name': 'Customer',
            'customer_email': 'Email',
            'ship_country': 'Country',
            'ship_province': 'Province',
            'ship_city': 'City',
            'ship_address1': 'Address 1',
            'ship_address2': 'Address 2',
            'ship_zip': 'Postal Code',
            'order_note': 'Notes',
            'is_international': 'International',
            'weight_over': 'Weight >',
            'weight_under': 'Weight <'
          } %}
          {% set cond_labels = {
            'contains': 'contains',
            'not_contains': 'not contains',
            'equals': '=',
            'not_equals': '≠'
          } %}
          {% for f in filters %}
          <span class="filter-tag">
            {{ field_labels.get(f.field, f.field) }} {{ cond_labels.get(f.condition, f.condition) }} <strong>{{ f.value }}</strong>
            <button type="button" class="remove-tag" onclick="removeFilterByIndex({{ loop.index0 }})">&times;</button>
          </span>
          {% endfor %}
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Selection Action Bar (hidden by default) -->
    <div id="selectionBar" class="selection-bar" style="display: none;">
      <div class="selection-info">
        <span id="selectedCount">0</span> orders selected
      </div>
      <div class="selection-actions">
        <button type="button" class="btn-clear-selection" onclick="clearSelection()">Clear</button>
        <button type="button" class="btn-create-batch" onclick="createBatchFromSelected()">
          Create Batch
        </button>
      </div>
    </div>

    <!-- Orders Table with Draggable Columns -->
    <div class="orders-table-container">
      {% if orders %}
        <table class="orders-table" id="ordersTable">
          <thead>
            <tr>
              <th style="width: 40px;" data-col="select" class="no-drag">
                <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)" title="Select all on this page">
              </th>
              <th class="sortable draggable {% if sort_by == 'order' %}sorted {{ sort_dir }}{% endif %}" data-col="order" draggable="true">
                <a href="{{ url_for('all_orders', filter=fulfillment_filter, q=search_query, sort='order', dir='asc' if sort_by == 'order' and sort_dir == 'desc' else 'desc', filters=filters_json) }}">
                  Order # <span class="sort-icon"></span>
                </a>
              </th>
              <th class="sortable draggable {% if sort_by == 'age' %}sorted {{ sort_dir }}{% endif %}" data-col="age" draggable="true">
                <a href="{{ url_for('all_orders', filter=fulfillment_filter, q=search_query, sort='age', dir='asc' if sort_by == 'age' and sort_dir == 'desc' else 'desc', filters=filters_json) }}">
                  Date <span class="sort-icon"></span>
                </a>
              </th>
              <th class="sortable draggable {% if sort_by == 'customer' %}sorted {{ sort_dir }}{% endif %}" data-col="customer" draggable="true">
                <a href="{{ url_for('all_orders', filter=fulfillment_filter, q=search_query, sort='customer', dir='asc' if sort_by == 'customer' and sort_dir == 'desc' else 'desc', filters=filters_json) }}">
                  Customer <span class="sort-icon"></span>
                </a>
              </th>
              <th class="draggable" data-col="items" draggable="true" title="Click to expand items">
                <span style="display: flex; align-items: center; gap: 6px;">
                  <button type="button" class="btn-expand-all" onclick="toggleAllItems(this)" title="Expand/Collapse all items">
                    <span class="expand-all-icon">▶</span>
                  </button>
                  Items
                </span>
              </th>
              <th class="draggable" data-col="qty" draggable="true">
                Qty
              </th>
              <th class="draggable" data-col="country" draggable="true">
                Country
              </th>
              <th class="draggable" data-col="tracking" draggable="true">
                Tracking #
              </th>
              <th class="sortable draggable {% if sort_by == 'status' %}sorted {{ sort_dir }}{% endif %}" data-col="status" draggable="true">
                <a href="{{ url_for('all_orders', filter=fulfillment_filter, q=search_query, sort='status', dir='asc' if sort_by == 'status' and sort_dir == 'desc' else 'desc', filters=filters_json) }}">
                  Status <span class="sort-icon"></span>
                </a>
              </th>
              <th data-col="actions" class="no-drag">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for order in orders %}
              <tr data-order="{{ order.order_number }}"
                  data-order-id="{{ order.id }}"
                  data-age="{{ order.shopify_created_at.isoformat() if order.shopify_created_at else '' }}"
                  data-customer="{{ order.customer_name or '' }}"
                  data-email="{{ order.customer_email or '' }}"
                  data-status="{{ order.fulfillment_status or 'unfulfilled' }}"
                  data-country="{{ order.ship_country or '' }}">
                <td data-col="select">
                  <input type="checkbox" class="order-checkbox" value="{{ order.order_number }}"
                         data-order-id="{{ order.id }}">
                </td>
                <td data-col="order">
                  <a href="#" onclick="showOrderDetails('{{ order.order_number }}'); return false;" class="order-number-link">
                    #{{ order.order_number }}
                  </a>
                </td>
                <td data-col="age">
                  <span class="order-age" data-created="{{ order.shopify_created_at.isoformat() if order.shopify_created_at else '' }}"></span>
                </td>
                <td data-col="customer">
                  {% if order.customer_name %}
                    <a href="#" onclick="showOrderDetails('{{ order.order_number }}'); return false;" style="color: #333; text-decoration: none;">
                      {{ order.customer_name }}
                    </a>
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td data-col="items" class="items-cell">
                  <button type="button" class="btn-expand-items" onclick="toggleOrderItems('{{ order.order_number }}', this)" title="View items">
                    <span class="expand-icon">▶</span> {{ order.line_item_count or 0 }} item{{ 's' if (order.line_item_count or 0) != 1 else '' }}
                  </button>
                  <div class="order-items-detail" id="items-{{ order.order_number }}" style="display: none;"></div>
                </td>
                <td data-col="qty" style="text-align: center; font-weight: 500;">
                  {{ order.item_qty|int if order.item_qty else 0 }}
                </td>
                <td data-col="country">
                  {% set country = order.ship_country or '' %}
                  {% if country %}
                    {% if country.upper() in ['CANADA', 'CA'] %}
                      <span style="color: #2e7d32;">{{ country }}</span>
                    {% elif country.upper() in ['UNITED STATES', 'US', 'USA'] %}
                      <span style="color: #1565c0;">{{ country }}</span>
                    {% else %}
                      <span style="color: #e65100; font-weight: 500;">{{ country }}</span>
                    {% endif %}
                  {% else %}
                    <span style="color: #999;">—</span>
                  {% endif %}
                </td>
                <td data-col="tracking">
                  {% if order.tracking_number %}
                    <span class="tracking-number">{{ order.tracking_number }}</span>
                  {% else %}
                    <span style="color: #999;">—</span>
                  {% endif %}
                </td>
                <td data-col="status">
                  {% set status = order.fulfillment_status or 'unfulfilled' %}
                  <span class="fulfillment-badge {{ status }}">
                    {{ status|capitalize }}
                  </span>
                </td>
                <td data-col="actions">
                  <button type="button" class="btn-cancel"
                          onclick="openCancelModal('{{ order.order_number }}', '{{ order.customer_name }}', '{{ order.customer_email }}', '{{ order.total_price }}', '{{ order.currency }}')">
                    Cancel
                  </button>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        <!-- Pagination -->
        <div class="pagination">
          <div class="pagination-info">
            Showing {{ ((page - 1) * per_page) + 1 }} - {{ [page * per_page, total_count]|min }} of {{ total_count }} orders
          </div>
          <div class="pagination-controls">
            {% if page > 1 %}
              <a href="{{ url_for('all_orders', filter=fulfillment_filter, q=search_query, page=page-1, filters=filters_json, sort=sort_by, dir=sort_dir) }}" class="pagination-btn">
                &larr; Previous
              </a>
            {% else %}
              <span class="pagination-btn disabled">&larr; Previous</span>
            {% endif %}

            {% if page < total_pages %}
              <a href="{{ url_for('all_orders', filter=fulfillment_filter, q=search_query, page=page+1, filters=filters_json, sort=sort_by, dir=sort_dir) }}" class="pagination-btn">
                Next &rarr;
              </a>
            {% else %}
              <span class="pagination-btn disabled">Next &rarr;</span>
            {% endif %}
          </div>
        </div>
      {% else %}
        <div class="empty-state">
          {% if search_query %}
            <h3>No orders found</h3>
            <p>No orders match your search "{{ search_query }}"</p>
          {% else %}
            <h3>No orders yet</h3>
            <p>Orders will appear here after the first sync from Shopify.</p>
            <button type="button" class="btn-refresh" onclick="syncOrders(true)" style="margin-top: 16px;">
              Run Initial Sync (90 days)
            </button>
          {% endif %}
        </div>
      {% endif %}
    </div>

    <!-- Order Details Modal - Full Screen -->
    <div id="orderModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center;">
      <div style="background: white; border-radius: 12px; width: 95%; max-width: 1400px; height: 90vh; display: flex; flex-direction: column; position: relative; box-shadow: 0 8px 40px rgba(0,0,0,0.3);">
        <div style="padding: 16px 24px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
          <h3 style="margin: 0; color: #333; font-size: 1.25rem;" id="orderModalTitle">Order Details</h3>
          <button onclick="closeOrderModal()" style="background: none; border: none; font-size: 1.75rem; cursor: pointer; color: #666; line-height: 1;">&times;</button>
        </div>
        <div id="orderModalContent" style="padding: 24px; overflow-y: auto; flex: 1;">
          <p style="text-align: center; color: #666;">Loading...</p>
        </div>
        <div style="padding: 16px 24px; border-top: 1px solid #eee; display: flex; justify-content: space-between; background: #f9f9f9; flex-wrap: wrap; gap: 8px; flex-shrink: 0; border-radius: 0 0 12px 12px;">
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <button onclick="printPackingSlip()" style="padding: 10px 20px; background: #534bc4; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Print Packing Slip</button>
            <button id="customsFormBtn" onclick="printCustomsForm()" style="padding: 10px 20px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; display: none;">Print Customs Form</button>
          </div>
          <button onclick="closeOrderModal()" style="padding: 10px 20px; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Close</button>
        </div>
      </div>
    </div>

    <!-- Cancel Order Modal -->
    <div class="modal-overlay" id="cancelModal">
      <div class="modal">
        <div class="modal-header">
          <h3>Cancel Order <span id="modalOrderNumber"></span></h3>
          <button type="button" class="modal-close" onclick="closeCancelModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div class="order-summary" id="orderSummary">
            <p><strong>Customer:</strong> <span id="modalCustomerName"></span></p>
            <p><strong>Email:</strong> <span id="modalCustomerEmail"></span></p>
            <p><strong>Order Total:</strong> <span id="modalOrderTotal"></span></p>
          </div>

          <div class="form-group">
            <label for="cancelReason">Reason for cancellation *</label>
            <select id="cancelReason" required>
              <option value="">Select a reason...</option>
              <option value="customer_cancelled">Customer cancelled</option>
              <option value="duplicate_order">Duplicate order</option>
              <option value="fraud">Fraud</option>
              <option value="refund_requested">Refund requested</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div class="form-group">
            <label for="cancelNotes">Additional notes (optional)</label>
            <textarea id="cancelNotes" placeholder="Enter any additional notes..."></textarea>
          </div>

          <div class="form-group">
            <label for="cancelledBy">Cancelled by</label>
            <input type="text" id="cancelledBy" placeholder="Your name (e.g., Jess, Tia)">
          </div>

          <div style="margin-top: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e0e0e0;">
            <h4 style="margin: 0 0 12px 0; font-size: 0.95rem; color: #333;">Shopify Actions</h4>

            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; cursor: pointer;">
              <input type="checkbox" id="cancelInShopify" checked style="width: 18px; height: 18px;">
              <span>Cancel order in Shopify</span>
            </label>

            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; cursor: pointer;">
              <input type="checkbox" id="issueRefund" checked style="width: 18px; height: 18px;">
              <span>Issue full refund</span>
            </label>

            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; cursor: pointer;">
              <input type="checkbox" id="emailCustomer" checked style="width: 18px; height: 18px;">
              <span>Email customer</span>
            </label>

            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="restockInventory" checked style="width: 18px; height: 18px;">
              <span>Restock inventory</span>
            </label>
          </div>

          <p style="font-size: 0.85rem; color: #d32f2f; margin-top: 16px;">
            <strong>Warning:</strong> This will cancel the order in Shopify and issue a refund. This action cannot be undone.
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-modal-cancel" onclick="closeCancelModal()">Keep Order</button>
          <button type="button" class="btn-modal-confirm" id="confirmCancelBtn" onclick="confirmCancel()" style="background: #d32f2f;">
            Cancel &amp; Refund Order
          </button>
        </div>
      </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
  // ── Order Details Modal ──
  let currentViewingOrderNumber = null;

  async function showOrderDetails(orderNumber) {
    currentViewingOrderNumber = orderNumber;
    const modal = document.getElementById('orderModal');
    const modalContent = document.getElementById('orderModalContent');
    const modalTitle = document.getElementById('orderModalTitle');
    const customsBtn = document.getElementById('customsFormBtn');

    modal.style.display = 'flex';
    modalTitle.textContent = `Order #${orderNumber}`;
    modalContent.innerHTML = '<p style="text-align: center; color: #666;">Loading...</p>';
    customsBtn.style.display = 'none'; // Hide customs button by default

    try {
      const response = await fetch(`/api/orders/${orderNumber}/details`);
      const data = await response.json();

      if (data.success) {
        const order = data.order;
        const items = data.line_items;
        const rateZone = data.rate_zone || {};

        // Check if international
        let isInternational = rateZone.is_international || false;
        const addr = order.shipping_address;
        if (addr && addr.country) {
          const country = addr.country.toUpperCase();
          if (country !== 'CANADA' && country !== 'CA') {
            isInternational = true;
            customsBtn.style.display = 'inline-block';
          }
        }

        let addressHtml = '';
        if (addr && Object.keys(addr).length > 0) {
          if (addr.raw) {
            addressHtml = `<p style="margin: 0; line-height: 1.6;">${addr.raw}</p>`;
          } else {
            addressHtml = `
              <p style="margin: 0; line-height: 1.6;">
                ${addr.name || ''}<br>
                ${addr.address1 || ''}${addr.address2 ? '<br>' + addr.address2 : ''}<br>
                ${addr.city || ''}, ${addr.province_code || addr.province || ''} ${addr.zip || ''}<br>
                ${addr.country || ''}
                ${addr.phone ? '<br>Phone: ' + addr.phone : ''}
              </p>
            `;
          }
        } else {
          addressHtml = '<p style="color: #999;">No shipping address</p>';
        }

        // Build items table with customs info
        let itemsHtml = '';
        if (items && items.length > 0) {
          itemsHtml = `
            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
              <thead>
                <tr style="background: #f5f5f5; text-align: left;">
                  <th style="padding: 10px; border-bottom: 2px solid #ddd;">Item</th>
                  <th style="padding: 10px; border-bottom: 2px solid #ddd; text-align: center;">Qty</th>
                  <th style="padding: 10px; border-bottom: 2px solid #ddd; text-align: right;">Price</th>
                  ${isInternational ? '<th style="padding: 10px; border-bottom: 2px solid #ddd;">HS Code</th><th style="padding: 10px; border-bottom: 2px solid #ddd;">Origin</th>' : ''}
                </tr>
              </thead>
              <tbody>
          `;
          items.forEach(item => {
            let propsHtml = '';
            if (item.properties && item.properties.length > 0) {
              propsHtml = '<div style="margin-top: 6px; padding: 6px 8px; background: #f8f9fa; border-radius: 4px; font-size: 0.85em;">' +
                item.properties.map(p => `<div style="color: #555;"><span style="color: #888;">${p.name}:</span> ${p.value}</div>`).join('') +
                '</div>';
            }
            itemsHtml += `
              <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 10px; vertical-align: top;">
                  <strong>${item.title}</strong>
                  ${item.variant ? '<br><span style="color: #666; font-size: 0.9em;">' + item.variant + '</span>' : ''}
                  ${item.sku ? '<br><span style="color: #999; font-size: 0.85em;">SKU: ' + item.sku + '</span>' : ''}
                  ${item.weight_grams ? '<br><span style="color: #888; font-size: 0.8em;">' + item.weight_grams + 'g</span>' : ''}
                  ${propsHtml}
                </td>
                <td style="padding: 10px; text-align: center; vertical-align: top; font-weight: 500;">${item.quantity}</td>
                <td style="padding: 10px; text-align: right; vertical-align: top;">$${item.price.toFixed(2)}</td>
                ${isInternational ? `
                  <td style="padding: 10px; vertical-align: top; font-family: monospace; font-size: 0.85em;">${item.hs_code || '<span style="color: #c62828;">Not set</span>'}</td>
                  <td style="padding: 10px; vertical-align: top;">${item.country_of_origin || 'CA'}</td>
                ` : ''}
              </tr>
            `;
          });
          itemsHtml += '</tbody></table>';
        } else {
          itemsHtml = '<p style="color: #999;">No items found</p>';
        }

        // Rate zone badge
        const rateZoneBadge = rateZone.zone ? `
          <span style="display: inline-block; background: ${isInternational ? '#1565c0' : '#2e7d32'}; color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.85em; font-weight: 500;">
            ${rateZone.zone}
          </span>
          ${rateZone.detail ? `<span style="color: #666; margin-left: 8px;">${rateZone.detail}</span>` : ''}
        ` : '';

        // Weight display
        const weightDisplay = order.total_weight_grams ?
          `<span style="color: #666; font-size: 0.9em;">${order.total_weight_grams}g (${(order.total_weight_grams / 1000).toFixed(2)}kg)</span>` : '';

        modalContent.innerHTML = `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            <!-- Left Column -->
            <div>
              <div style="margin-bottom: 24px; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                <h4 style="margin: 0 0 12px 0; color: #333; font-size: 0.95rem; text-transform: uppercase; letter-spacing: 0.5px;">Customer</h4>
                <p style="margin: 0; font-size: 1.1em;"><strong>${order.customer_name || 'Unknown'}</strong></p>
                <p style="margin: 4px 0; color: #666;">${order.customer_email || ''}</p>
                ${order.customer_phone ? '<p style="margin: 4px 0; color: #666;">' + order.customer_phone + '</p>' : ''}
              </div>

              <div style="margin-bottom: 24px; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                <h4 style="margin: 0 0 12px 0; color: #333; font-size: 0.95rem; text-transform: uppercase; letter-spacing: 0.5px;">
                  Shipping Address
                </h4>
                ${addressHtml}
              </div>

              <!-- Rate Zone / Shipping Info -->
              <div style="margin-bottom: 24px; padding: 16px; background: ${isInternational ? '#e3f2fd' : '#e8f5e9'}; border-radius: 8px; border: 1px solid ${isInternational ? '#90caf9' : '#a5d6a7'};">
                <h4 style="margin: 0 0 12px 0; color: #333; font-size: 0.95rem; text-transform: uppercase; letter-spacing: 0.5px;">
                  Shipping Zone
                </h4>
                <div style="margin-bottom: 8px;">${rateZoneBadge}</div>
                <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-top: 12px;">
                  <div>
                    <span style="color: #666; font-size: 0.85em;">Total Items:</span>
                    <strong style="margin-left: 4px;">${order.total_items_qty || items.reduce((sum, i) => sum + i.quantity, 0)}</strong>
                  </div>
                  ${order.total_weight_grams ? `
                    <div>
                      <span style="color: #666; font-size: 0.85em;">Total Weight:</span>
                      <strong style="margin-left: 4px;">${order.total_weight_grams}g</strong>
                    </div>
                  ` : ''}
                </div>
              </div>

              <!-- Order Summary -->
              <div style="background: #fff; padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0;">
                <h4 style="margin: 0 0 12px 0; color: #333; font-size: 0.95rem; text-transform: uppercase; letter-spacing: 0.5px;">Order Summary</h4>
                <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                  <span style="color: #666;">Subtotal:</span><span>$${order.subtotal_price.toFixed(2)} ${order.currency || ''}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                  <span style="color: #666;">Tax:</span><span>$${order.total_tax.toFixed(2)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.15em; border-top: 2px solid #333; padding-top: 10px; margin-top: 10px;">
                  <span>Total:</span><span>$${order.total_price.toFixed(2)} ${order.currency || ''}</span>
                </div>
              </div>
            </div>

            <!-- Right Column - Items -->
            <div>
              <div style="padding: 16px; background: #fff; border-radius: 8px; border: 1px solid #e0e0e0;">
                <h4 style="margin: 0 0 16px 0; color: #333; font-size: 0.95rem; text-transform: uppercase; letter-spacing: 0.5px;">
                  Items Ordered (${order.total_items_qty || items.reduce((sum, i) => sum + i.quantity, 0)} items)
                </h4>
                ${itemsHtml}
              </div>

              ${isInternational ? `
                <div style="margin-top: 16px; padding: 16px; background: #fff3e0; border-radius: 8px; border: 1px solid #ffcc80;">
                  <h4 style="margin: 0 0 12px 0; color: #e65100; font-size: 0.95rem;">
                    ⚠ Customs Information Required
                  </h4>
                  <p style="margin: 0; color: #666; font-size: 0.9em;">
                    This is an international order to <strong>${rateZone.detail || 'an international destination'}</strong>.
                    Ensure all items have valid HS codes and customs descriptions before shipping.
                  </p>
                  <button onclick="printCustomsForm()" style="margin-top: 12px; padding: 8px 16px; background: #e65100; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">
                    Generate Customs Form
                  </button>
                </div>
              ` : ''}
            </div>
          </div>

          ${order.note ? '<div style="margin-top: 20px; padding: 14px; background: #fff8e1; border-radius: 8px; border: 1px solid #ffe082;"><strong>Customer Note:</strong> ' + order.note + '</div>' : ''}
          ${order.cancelled ? '<div style="margin-top: 20px; padding: 14px; background: #ffebee; border-radius: 8px; border: 1px solid #ef9a9a; color: #c62828;"><strong>⚠ This order has been cancelled</strong></div>' : ''}
        `;

      } else {
        modalContent.innerHTML = `<p style="text-align: center; color: #c62828;">Error: ${data.error || 'Could not load order'}</p>`;
      }
    } catch (error) {
      console.error('Error loading order:', error);
      modalContent.innerHTML = '<p style="text-align: center; color: #c62828;">Error loading order details</p>';
    }
  }

  function closeOrderModal() {
    document.getElementById('orderModal').style.display = 'none';
    currentViewingOrderNumber = null;
  }

  function printPackingSlip() {
    if (!currentViewingOrderNumber) {
      alert('No order selected');
      return;
    }
    window.open('/api/orders/' + currentViewingOrderNumber + '/packing-slip', '_blank');
  }

  function printCustomsForm() {
    if (!currentViewingOrderNumber) {
      alert('No order selected');
      return;
    }
    window.open('/api/orders/' + currentViewingOrderNumber + '/customs-form', '_blank');
  }

  document.getElementById('orderModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeOrderModal();
    }
  });

  // ── Cancel Order Modal ──
  let currentOrderNumber = null;

  function openCancelModal(orderNumber, customerName, customerEmail, totalPrice, currency) {
    currentOrderNumber = orderNumber;
    document.getElementById('modalOrderNumber').textContent = '#' + orderNumber;
    document.getElementById('modalCustomerName').textContent = customerName || '—';
    document.getElementById('modalCustomerEmail').textContent = customerEmail || '—';
    document.getElementById('modalOrderTotal').textContent = '$' + (parseFloat(totalPrice) || 0).toFixed(2) + ' ' + (currency || 'CAD');
    document.getElementById('cancelModal').classList.add('show');
  }

  function closeCancelModal() {
    currentOrderNumber = null;
    document.getElementById('cancelModal').classList.remove('show');
    document.getElementById('cancelReason').value = '';
    document.getElementById('cancelNotes').value = '';
    document.getElementById('cancelledBy').value = '';
    // Reset checkboxes to default (checked)
    document.getElementById('cancelInShopify').checked = true;
    document.getElementById('issueRefund').checked = true;
    document.getElementById('emailCustomer').checked = true;
    document.getElementById('restockInventory').checked = true;
  }

  async function confirmCancel() {
    const reason = document.getElementById('cancelReason').value;
    if (!reason) {
      alert('Please select a reason for cancellation.');
      return;
    }

    const cancelInShopify = document.getElementById('cancelInShopify').checked;
    const issueRefund = document.getElementById('issueRefund').checked;

    // Double-check with user if they're doing Shopify actions
    if (cancelInShopify || issueRefund) {
      const confirmMsg = `Are you sure you want to cancel order #${currentOrderNumber}?\n\n` +
        (cancelInShopify ? '- Cancel order in Shopify\n' : '') +
        (issueRefund ? '- Issue full refund to customer\n' : '') +
        '\nThis action cannot be undone.';

      if (!confirm(confirmMsg)) {
        return;
      }
    }

    const btn = document.getElementById('confirmCancelBtn');
    btn.disabled = true;
    btn.textContent = issueRefund ? 'Processing refund...' : 'Cancelling...';

    try {
      const response = await fetch('/api/orders/' + currentOrderNumber + '/cancel', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          reason: reason,
          reason_notes: document.getElementById('cancelNotes').value,
          cancelled_by: document.getElementById('cancelledBy').value,
          cancel_in_shopify: cancelInShopify,
          issue_refund: issueRefund,
          email_customer: document.getElementById('emailCustomer').checked,
          restock_inventory: document.getElementById('restockInventory').checked
        })
      });

      const data = await response.json();

      if (data.success) {
        let message = 'Order #' + currentOrderNumber + ' has been cancelled.';

        if (data.shopify_cancelled) {
          message += '\n\nShopify: Order cancelled';
        } else if (data.shopify_error) {
          message += '\n\nShopify cancellation failed: ' + data.shopify_error;
        }

        if (data.refund_issued) {
          message += '\nRefund: $' + (data.refund_amount || 0).toFixed(2) + ' refunded';
        } else if (data.refund_error) {
          message += '\nRefund failed: ' + data.refund_error;
        }

        alert(message);
        closeCancelModal();
        location.reload();
      } else {
        alert('Error: ' + (data.error || 'Unknown error'));
      }
    } catch (error) {
      alert('Error cancelling order: ' + error.message);
    } finally {
      btn.disabled = false;
      btn.textContent = 'Cancel & Refund Order';
    }
  }

  async function syncOrders(fullSync) {
    const refreshBtn = document.getElementById('refreshBtn');
    const fullSyncBtn = document.getElementById('fullSyncBtn');

    refreshBtn.disabled = true;
    fullSyncBtn.disabled = true;
    refreshBtn.classList.add('syncing');

    const syncStatus = document.getElementById('syncStatus');
    syncStatus.textContent = 'Starting sync...';
    syncStatus.classList.add('syncing');

    try {
      const url = fullSync ? '/api/orders/sync?full=true' : '/api/orders/sync';
      const response = await fetch(url, {method: 'POST'});

      // Check if response is JSON
      const contentType = response.headers.get('content-type');
      if (!contentType || !contentType.includes('application/json')) {
        const text = await response.text();
        console.error('Non-JSON response:', text.substring(0, 200));
        throw new Error('Server returned an error. Please try again or check the logs.');
      }

      const data = await response.json();

      if (data.success) {
        if (data.async) {
          // Async sync started - poll for status
          syncStatus.textContent = 'Sync running in background... Checking status...';
          pollSyncStatus();
        } else {
          syncStatus.textContent = 'Synced ' + data.synced_count + ' orders. Refreshing...';
          setTimeout(() => location.reload(), 1000);
        }
      } else {
        if (data.status === 'running') {
          syncStatus.textContent = 'Sync already in progress. Checking status...';
          pollSyncStatus();
        } else {
          alert('Sync failed: ' + (data.error || 'Unknown error'));
          syncStatus.textContent = 'Sync failed';
          resetSyncButtons();
        }
      }
    } catch (error) {
      console.error('Sync error:', error);
      alert('Error syncing: ' + error.message);
      syncStatus.textContent = 'Sync error - please try again';
      resetSyncButtons();
    }
  }

  function resetSyncButtons() {
    const refreshBtn = document.getElementById('refreshBtn');
    const fullSyncBtn = document.getElementById('fullSyncBtn');
    const syncStatus = document.getElementById('syncStatus');

    refreshBtn.disabled = false;
    fullSyncBtn.disabled = false;
    refreshBtn.classList.remove('syncing');
    syncStatus.classList.remove('syncing');
  }

  async function pollSyncStatus() {
    const syncStatus = document.getElementById('syncStatus');
    let attempts = 0;
    const maxAttempts = 120; // Poll for up to 10 minutes

    const poll = async () => {
      attempts++;
      try {
        const response = await fetch('/api/orders/sync/status');
        const status = await response.json();

        if (status.status === 'running') {
          // Check if sync was interrupted (stale running status)
          if (status.can_resume || status.status_hint === 'interrupted') {
            syncStatus.innerHTML = `Sync was interrupted at page ${status.current_page || '?'}. ` +
              `<a href="#" onclick="resumeSync(); return false;" style="color: #534bc4;">Click to resume</a>`;
            resetSyncButtons();
            return;
          }

          // Show progress info if available
          let progressText = 'Sync in progress...';
          if (status.progress_message) {
            progressText = status.progress_message;
          } else if (status.synced_so_far > 0) {
            progressText = `Syncing... ${status.synced_so_far} orders processed`;
          }
          syncStatus.textContent = progressText;

          if (attempts < maxAttempts) {
            setTimeout(poll, 3000); // Check every 3 seconds for better feedback
          } else {
            syncStatus.textContent = 'Sync still running. Refresh page to check later.';
            resetSyncButtons();
          }
        } else if (status.status === 'idle') {
          const count = status.last_sync_count || 0;
          syncStatus.textContent = 'Synced ' + count + ' orders. Refreshing...';
          setTimeout(() => location.reload(), 1500);
        } else if (status.status === 'error') {
          alert('Sync error: ' + (status.error_message || 'Unknown error'));
          syncStatus.textContent = 'Sync failed: ' + (status.error_message || 'Unknown error');
          resetSyncButtons();
        } else {
          // Unknown status, reload anyway
          location.reload();
        }
      } catch (error) {
        console.error('Error polling sync status:', error);
        if (attempts < maxAttempts) {
          setTimeout(poll, 5000);
        } else {
          syncStatus.textContent = 'Could not check sync status. Refresh page.';
          resetSyncButtons();
        }
      }
    };

    // Start polling after a brief delay
    setTimeout(poll, 3000);
  }

  async function resumeSync() {
    const syncStatus = document.getElementById('syncStatus');
    syncStatus.textContent = 'Resuming sync...';

    try {
      const response = await fetch('/api/orders/sync?resume=true', {method: 'POST'});
      const data = await response.json();

      if (data.success) {
        syncStatus.textContent = 'Sync resumed. Checking progress...';
        pollSyncStatus();
      } else {
        alert('Failed to resume: ' + (data.error || 'Unknown error'));
        syncStatus.textContent = 'Resume failed';
      }
    } catch (error) {
      alert('Error resuming sync: ' + error.message);
      syncStatus.textContent = 'Resume error';
    }
  }

  // Check sync status on page load
  (async function checkInitialStatus() {
    try {
      const response = await fetch('/api/orders/sync/status');
      const status = await response.json();

      if (status.status === 'running') {
        if (status.can_resume || status.status_hint === 'interrupted') {
          document.getElementById('syncStatus').innerHTML =
            `Sync was interrupted at page ${status.current_page || '?'} (${status.synced_so_far || 0} orders). ` +
            `<a href="#" onclick="resumeSync(); return false;" style="color: #534bc4; font-weight: 500;">Click to resume</a>`;
        } else {
          document.getElementById('syncStatus').textContent = status.progress_message || 'Sync in progress...';
          pollSyncStatus();
        }
      }
    } catch (e) {
      console.error('Error checking initial sync status:', e);
    }
  })();

  // Close modals on escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeOrderModal();
      closeCancelModal();
    }
  });

  // Close modal on backdrop click
  document.getElementById('cancelModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeCancelModal();
    }
  });

  // Calculate and display order ages
  function formatRelativeTime(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'just now';
    if (diffMins < 60) return diffMins + ' min' + (diffMins !== 1 ? 's' : '');
    if (diffHours < 24) return diffHours + ' hr' + (diffHours !== 1 ? 's' : '');
    if (diffDays < 7) return diffDays + ' day' + (diffDays !== 1 ? 's' : '');
    if (diffDays < 30) {
      const weeks = Math.floor(diffDays / 7);
      return weeks + ' week' + (weeks !== 1 ? 's' : '');
    }
    const months = Math.floor(diffDays / 30);
    return months + ' month' + (months !== 1 ? 's' : '');
  }

  function updateOrderAges() {
    document.querySelectorAll('.order-age').forEach(function(el) {
      const created = el.dataset.created;
      if (created) {
        const age = formatRelativeTime(created);
        el.textContent = age;

        // Add classes for styling - Green (fresh) → Orange (medium) → Red (old)
        const date = new Date(created);
        const now = new Date();
        const diffHours = (now - date) / 3600000;

        // Remove all age classes first
        el.classList.remove('recent', 'medium', 'old');

        if (diffHours < 4) {
          // Fresh: Green - Less than 4 hours old
          el.classList.add('recent');
        } else if (diffHours <= 48) {
          // Medium: Orange - Between 4 and 48 hours old
          el.classList.add('medium');
        } else {
          // Old: Red - More than 48 hours old
          el.classList.add('old');
        }
      }
    });
  }

  // Run on page load and refresh every minute
  updateOrderAges();
  setInterval(updateOrderAges, 60000);

  // NOTE: Client-side sorting removed - now using server-side sorting via URL parameters
  // Sort links in table headers handle sorting across all pages

  // Advanced filter functions
  function toggleFilters() {
    const content = document.getElementById('filterContent');
    const toggleText = document.getElementById('filterToggleText');
    if (content.style.display === 'none') {
      content.style.display = 'block';
      toggleText.textContent = 'Hide';
    } else {
      content.style.display = 'none';
      toggleText.textContent = 'Show';
    }
  }

  function getFiltersFromRows() {
    const filters = [];
    const rows = document.querySelectorAll('#filterRowsContainer .filter-row');
    console.log('Found filter rows:', rows.length);
    rows.forEach(function(row, index) {
      console.log('Row', index, 'id:', row.id);
      if (row.id === 'newFilterRow') {
        console.log('Skipping newFilterRow in forEach');
        return; // Skip the empty template row
      }
      const field = row.querySelector('.filter-field').value;
      const condition = row.querySelector('.filter-condition').value;
      const value = row.querySelector('.filter-value').value.trim();
      console.log('Row', index, ':', { field, condition, value });
      if (field && value) {
        filters.push({ field: field, condition: condition, value: value });
      }
    });
    // Also check the new filter row
    const newRow = document.getElementById('newFilterRow');
    if (newRow) {
      const newField = newRow.querySelector('.filter-field').value;
      const newCondition = newRow.querySelector('.filter-condition').value;
      const newValue = newRow.querySelector('.filter-value').value.trim();
      console.log('newFilterRow:', { newField, newCondition, newValue });
      if (newField && newValue) {
        filters.push({ field: newField, condition: newCondition, value: newValue });
      }
    }
    console.log('Collected filters:', filters);
    return filters;
  }

  function applyFilters() {
    const filters = getFiltersFromRows();
    console.log('Applying filters:', filters);
    if (filters.length === 0) {
      alert('Please add at least one filter with a field and value');
      return;
    }
    document.getElementById('filtersJson').value = JSON.stringify(filters);
    console.log('Submitting filters JSON:', document.getElementById('filtersJson').value);
    document.getElementById('advancedFilterForm').submit();
  }

  function addFilterRow() {
    const newRow = document.getElementById('newFilterRow');
    const field = newRow.querySelector('.filter-field').value;
    const condition = newRow.querySelector('.filter-condition').value;
    const value = newRow.querySelector('.filter-value').value.trim();

    if (!field || !value) {
      alert('Please select a field and enter a value');
      return;
    }

    // Clone the row and add it before newFilterRow
    const clone = newRow.cloneNode(true);
    clone.removeAttribute('id');
    clone.querySelector('.filter-field').value = field;
    clone.querySelector('.filter-condition').value = condition;
    clone.querySelector('.filter-value').value = value;

    // Change the + button to an X button
    const btn = clone.querySelector('button');
    btn.textContent = '×';
    btn.className = 'btn-remove-filter';
    btn.setAttribute('onclick', 'removeFilterRow(this)');

    const container = document.getElementById('filterRowsContainer');
    container.insertBefore(clone, newRow);

    // Clear the new row for next filter
    newRow.querySelector('.filter-field').value = '';
    newRow.querySelector('.filter-condition').value = 'contains';
    newRow.querySelector('.filter-value').value = '';
  }

  function removeFilterRow(btn) {
    const row = btn.closest('.filter-row');
    row.remove();
  }

  function removeFilterByIndex(index) {
    // Parse current filters, remove by index, and resubmit
    const filtersJson = document.getElementById('filtersJson').value;
    let filters = [];
    try {
      filters = JSON.parse(filtersJson) || [];
    } catch (e) {}
    filters.splice(index, 1);
    document.getElementById('filtersJson').value = JSON.stringify(filters);
    document.getElementById('advancedFilterForm').submit();
  }

  function clearAdvancedFilters() {
    document.getElementById('filtersJson').value = '';
    // Remove all filter rows except the new row
    const rows = document.querySelectorAll('#filterRowsContainer .filter-row');
    rows.forEach(function(row) {
      if (row.id !== 'newFilterRow') {
        row.remove();
      }
    });
    // Clear the new row
    const newRow = document.getElementById('newFilterRow');
    newRow.querySelector('.filter-field').value = '';
    newRow.querySelector('.filter-condition').value = 'contains';
    newRow.querySelector('.filter-value').value = '';
    // Submit to clear
    document.getElementById('advancedFilterForm').submit();
  }

  // Debug: Log filters on page load
  document.addEventListener('DOMContentLoaded', function() {
    const filtersJson = document.getElementById('filtersJson').value;
    console.log('Page loaded with filters JSON:', filtersJson);
    if (filtersJson) {
      try {
        const filters = JSON.parse(filtersJson);
        console.log('Parsed filters:', filters);
      } catch (e) {
        console.error('Failed to parse filters JSON:', e);
      }
    }
  });

  // ═══════════════════════════════════════════════════════════════════════════
  // Order Selection & Batch Creation (with Shift+Click support)
  // ═══════════════════════════════════════════════════════════════════════════

  let lastCheckedIndex = null;  // Track last clicked checkbox for shift-select

  function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.order-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
    lastCheckedIndex = null;  // Reset shift-select tracking
    updateSelection();
  }

  function updateSelection() {
    const checkboxes = document.querySelectorAll('.order-checkbox:checked');
    const count = checkboxes.length;
    const selectionBar = document.getElementById('selectionBar');
    const selectedCount = document.getElementById('selectedCount');
    const selectAllCheckbox = document.getElementById('selectAll');
    const allCheckboxes = document.querySelectorAll('.order-checkbox');

    selectedCount.textContent = count;
    selectionBar.style.display = count > 0 ? 'flex' : 'none';

    // Update "select all" checkbox state
    if (count === 0) {
      selectAllCheckbox.checked = false;
      selectAllCheckbox.indeterminate = false;
    } else if (count === allCheckboxes.length) {
      selectAllCheckbox.checked = true;
      selectAllCheckbox.indeterminate = false;
    } else {
      selectAllCheckbox.checked = false;
      selectAllCheckbox.indeterminate = true;
    }
  }

  function clearSelection() {
    document.querySelectorAll('.order-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('selectAll').checked = false;
    lastCheckedIndex = null;
    updateSelection();
  }

  // Handle checkbox click with shift-select support
  function handleCheckboxClick(event) {
    const checkboxes = Array.from(document.querySelectorAll('.order-checkbox'));
    const clickedIndex = checkboxes.indexOf(event.target);

    if (event.shiftKey && lastCheckedIndex !== null && clickedIndex !== lastCheckedIndex) {
      // Shift+click: select range between last clicked and current
      const start = Math.min(lastCheckedIndex, clickedIndex);
      const end = Math.max(lastCheckedIndex, clickedIndex);
      const shouldCheck = checkboxes[lastCheckedIndex].checked;

      for (let i = start; i <= end; i++) {
        checkboxes[i].checked = shouldCheck;
      }
    }

    lastCheckedIndex = clickedIndex;
    updateSelection();
  }

  // Initialize shift-click handlers on page load
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.order-checkbox').forEach(function(checkbox) {
      checkbox.addEventListener('click', handleCheckboxClick);
    });
  });

  function getSelectedOrders() {
    const checkboxes = document.querySelectorAll('.order-checkbox:checked');
    return Array.from(checkboxes).map(cb => ({
      order_number: cb.value,
      order_id: cb.dataset.orderId
    }));
  }

  function createBatchFromSelected() {
    const selected = getSelectedOrders();
    if (selected.length === 0) {
      alert('Please select at least one order');
      return;
    }

    // Create a form and submit to the new batch creation endpoint
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("create_order_batch") }}';

    // Add CSRF token if you have one (for Flask-WTF)
    // const csrfInput = document.createElement('input');
    // csrfInput.type = 'hidden';
    // csrfInput.name = 'csrf_token';
    // csrfInput.value = '...';
    // form.appendChild(csrfInput);

    const ordersInput = document.createElement('input');
    ordersInput.type = 'hidden';
    ordersInput.name = 'order_numbers';
    ordersInput.value = JSON.stringify(selected.map(o => o.order_number));
    form.appendChild(ordersInput);

    document.body.appendChild(form);
    form.submit();
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // Expandable Order Items
  // ═══════════════════════════════════════════════════════════════════════════

  const expandedOrders = new Set();
  const itemsCache = {};

  async function toggleOrderItems(orderNumber, btn) {
    const container = document.getElementById(`items-${orderNumber}`);
    const icon = btn.querySelector('.expand-icon');

    if (expandedOrders.has(orderNumber)) {
      // Collapse
      container.style.display = 'none';
      icon.textContent = '▶';
      expandedOrders.delete(orderNumber);
    } else {
      // Expand
      icon.textContent = '▼';
      expandedOrders.add(orderNumber);

      if (itemsCache[orderNumber]) {
        container.innerHTML = itemsCache[orderNumber];
        container.style.display = 'block';
      } else {
        container.innerHTML = '<div style="padding: 8px; color: #666; font-size: 0.85em;">Loading...</div>';
        container.style.display = 'block';

        try {
          const response = await fetch(`/api/orders/${orderNumber}/details`);
          const data = await response.json();

          if (data.success && data.line_items) {
            let html = '<div style="padding: 8px 0; font-size: 0.85em;">';
            data.line_items.forEach(item => {
              html += `
                <div style="padding: 6px 0; border-bottom: 1px solid #f0f0f0;">
                  <div style="display: flex; justify-content: space-between;">
                    <span><strong>${item.quantity}×</strong> ${item.title}</span>
                    <span style="color: #666;">$${item.price.toFixed(2)}</span>
                  </div>
                  ${item.variant ? `<div style="color: #888; font-size: 0.9em;">${item.variant}</div>` : ''}
                  ${item.sku ? `<div style="color: #999; font-size: 0.85em;">SKU: ${item.sku}</div>` : ''}
                </div>
              `;
            });
            html += '</div>';
            itemsCache[orderNumber] = html;
            container.innerHTML = html;
          } else {
            container.innerHTML = '<div style="padding: 8px; color: #c62828; font-size: 0.85em;">Failed to load items</div>';
          }
        } catch (err) {
          container.innerHTML = '<div style="padding: 8px; color: #c62828; font-size: 0.85em;">Error loading items</div>';
        }
      }
    }
  }

  // Bulk expand/collapse all items
  let allExpanded = false;

  function toggleAllItems(headerBtn) {
    const icon = headerBtn.querySelector('.expand-all-icon');

    if (allExpanded) {
      // Collapse all
      collapseAllItems();
      icon.textContent = '▶';
      allExpanded = false;
    } else {
      // Expand all
      expandAllItems();
      icon.textContent = '▼';
      allExpanded = true;
    }
  }

  function expandAllItems() {
    document.querySelectorAll('.btn-expand-items').forEach(btn => {
      const orderNumber = btn.closest('tr').dataset.order;
      if (!expandedOrders.has(orderNumber)) {
        toggleOrderItems(orderNumber, btn);
      }
    });
  }

  function collapseAllItems() {
    document.querySelectorAll('.btn-expand-items').forEach(btn => {
      const orderNumber = btn.closest('tr').dataset.order;
      if (expandedOrders.has(orderNumber)) {
        toggleOrderItems(orderNumber, btn);
      }
    });
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // Draggable Columns
  // ═══════════════════════════════════════════════════════════════════════════

  let dragSrcCol = null;

  function initDraggableColumns() {
    const table = document.getElementById('ordersTable');
    if (!table) return;

    const headers = table.querySelectorAll('th.draggable');

    headers.forEach(header => {
      header.addEventListener('dragstart', handleDragStart);
      header.addEventListener('dragover', handleDragOver);
      header.addEventListener('dragenter', handleDragEnter);
      header.addEventListener('dragleave', handleDragLeave);
      header.addEventListener('drop', handleDrop);
      header.addEventListener('dragend', handleDragEnd);
    });
  }

  function handleDragStart(e) {
    dragSrcCol = this;
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', this.dataset.col);
    this.classList.add('dragging');
  }

  function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    return false;
  }

  function handleDragEnter(e) {
    this.classList.add('drag-over');
  }

  function handleDragLeave(e) {
    this.classList.remove('drag-over');
  }

  function handleDrop(e) {
    e.stopPropagation();
    e.preventDefault();

    if (dragSrcCol !== this) {
      const srcCol = dragSrcCol.dataset.col;
      const destCol = this.dataset.col;

      // Swap columns in all rows
      const table = document.getElementById('ordersTable');
      const srcIndex = getColumnIndex(srcCol);
      const destIndex = getColumnIndex(destCol);

      if (srcIndex !== -1 && destIndex !== -1) {
        // Swap in header
        const headerRow = table.querySelector('thead tr');
        swapCells(headerRow, srcIndex, destIndex);

        // Swap in all body rows
        table.querySelectorAll('tbody tr').forEach(row => {
          swapCells(row, srcIndex, destIndex);
        });

        // Save column order to localStorage
        saveColumnOrder();
      }
    }

    this.classList.remove('drag-over');
    return false;
  }

  function handleDragEnd(e) {
    this.classList.remove('dragging');
    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
  }

  function getColumnIndex(colName) {
    const headers = document.querySelectorAll('#ordersTable th');
    for (let i = 0; i < headers.length; i++) {
      if (headers[i].dataset.col === colName) return i;
    }
    return -1;
  }

  function swapCells(row, idx1, idx2) {
    const cells = row.children;
    if (idx1 < idx2) {
      row.insertBefore(cells[idx2], cells[idx1]);
    } else {
      row.insertBefore(cells[idx1], cells[idx2]);
    }
  }

  function saveColumnOrder() {
    const headers = document.querySelectorAll('#ordersTable th');
    const order = Array.from(headers).map(h => h.dataset.col);
    localStorage.setItem('allOrdersColumnOrder', JSON.stringify(order));
  }

  function loadColumnOrder() {
    const saved = localStorage.getItem('allOrdersColumnOrder');
    if (!saved) return;

    try {
      const order = JSON.parse(saved);
      const table = document.getElementById('ordersTable');
      if (!table) return;

      const headerRow = table.querySelector('thead tr');
      const rows = table.querySelectorAll('tbody tr');

      // Build index map
      const currentOrder = Array.from(headerRow.children).map(h => h.dataset.col);
      const newOrder = order.filter(col => currentOrder.includes(col));

      // Add any new columns that aren't in saved order
      currentOrder.forEach(col => {
        if (!newOrder.includes(col)) newOrder.push(col);
      });

      // Reorder each row
      [headerRow, ...rows].forEach(row => {
        const cells = Array.from(row.children);
        const cellMap = {};
        cells.forEach(cell => {
          cellMap[cell.dataset.col] = cell;
        });

        // Clear and rebuild
        row.innerHTML = '';
        newOrder.forEach(col => {
          if (cellMap[col]) {
            row.appendChild(cellMap[col]);
          }
        });
      });
    } catch (e) {
      console.error('Error loading column order:', e);
    }
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function() {
    initDraggableColumns();
    loadColumnOrder();
  });
</script>

<style>
  /* Draggable column styles */
  th.draggable {
    cursor: grab;
    user-select: none;
  }
  th.draggable:active {
    cursor: grabbing;
  }
  th.dragging {
    opacity: 0.5;
    background: #e3f2fd !important;
  }
  th.drag-over {
    background: #bbdefb !important;
    border-left: 3px solid #1976d2;
  }

  /* Expand all button in header */
  .btn-expand-all {
    background: none;
    border: 1px solid #bbb;
    border-radius: 3px;
    padding: 2px 6px;
    font-size: 0.75em;
    cursor: pointer;
    color: #555;
    transition: all 0.2s;
    line-height: 1;
  }
  .btn-expand-all:hover {
    background: #e3f2fd;
    border-color: #1976d2;
    color: #1976d2;
  }
  .expand-all-icon {
    font-size: 0.9em;
  }

  /* Expand items button styles */
  .btn-expand-items {
    background: none;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 0.85em;
    cursor: pointer;
    color: #333;
    transition: all 0.2s;
  }
  .btn-expand-items:hover {
    background: #f5f5f5;
    border-color: #bbb;
  }
  .expand-icon {
    display: inline-block;
    font-size: 0.7em;
    margin-right: 4px;
    transition: transform 0.2s;
  }
  .order-items-detail {
    margin-top: 8px;
    padding: 8px;
    background: #fafafa;
    border: 1px solid #eee;
    border-radius: 4px;
    max-height: 200px;
    overflow-y: auto;
  }

  /* Items cell */
  .items-cell {
    min-width: 120px;
  }
</style>
{% endblock %}
