{% extends "base.html" %}

{% block title %}Live Tracking - H&O Parcel Scans{% endblock %}

{% block extra_styles %}{% endblock %}

{% block content %}
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
      <h2>ğŸ“¦ Live Tracking</h2>
      <div style="display: flex; align-items: center; gap: 12px;">
        <span id="lastUpdate" style="font-size: 0.85rem; color: #666;"></span>
        <button type="button" onclick="forceRefreshTracking()" class="btn btn-search btn-refresh">ğŸ”„ Refresh Tracking</button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn {{ 'active' if current_tab == 'batches' else '' }}" onclick="switchTab('batches')">Recent Batches</button>
      <button class="tab-btn {{ 'active' if current_tab == 'shipments' else '' }}" onclick="switchTab('shipments')">All Shipments</button>
    </div>

    <!-- Tab: Recent Batches -->
    <div id="tab-batches" class="tab-content {{ 'active' if current_tab == 'batches' else '' }}">
      <p style="margin-bottom: 16px; color: #666;">
        Recently processed ShipStation batches. Click a batch to see shipment details.
      </p>

      <div class="status-filters">
        <a href="{{ url_for('check_shipments', tab='batches', status='completed') }}" class="filter-btn {{ 'active' if batch_status == 'completed' else '' }}">Completed</a>
        <a href="{{ url_for('check_shipments', tab='batches', status='processing') }}" class="filter-btn {{ 'active' if batch_status == 'processing' else '' }}">Processing</a>
        <a href="{{ url_for('check_shipments', tab='batches', status='open') }}" class="filter-btn {{ 'active' if batch_status == 'open' else '' }}">Open</a>
        <a href="{{ url_for('check_shipments', tab='batches', status='queued') }}" class="filter-btn {{ 'active' if batch_status == 'queued' else '' }}">Queued</a>
      </div>

      {% if batch_error %}
        <div class="flash error">{{ batch_error }}</div>
      {% endif %}

      {% if batches %}
        <table>
          <thead>
            <tr>
              <th>Batch ID</th>
              <th>Notes</th>
              <th>Created</th>
              <th>Count</th>
              <th>Status</th>
              <th>Errors</th>
            </tr>
          </thead>
          <tbody>
            {% for b in batches %}
              <tr>
                <td><a class="batch-link" href="{{ url_for('ss_batch_detail', batch_id=b.batch_id) }}">{{ b.batch_number or b.batch_id.replace('se-', '') if b.batch_id else '-' }}</a></td>
                <td>{{ b.batch_notes or '-' }}</td>
                <td>{{ b.created_at[:16] if b.created_at else '-' }}</td>
                <td>{{ b.count }}</td>
                <td><span class="status-badge status-{{ b.status }}">{{ b.status }}</span></td>
                <td>{{ b.errors or 0 }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        <div class="pagination">
          {# Previous button #}
          <a href="{{ url_for('check_shipments', tab='batches', status=batch_status, page=batch_page-1) }}" class="{% if batch_page <= 1 %}disabled{% endif %}">â† Prev</a>

          {# Page numbers for batches #}
          {% set b_show = 5 %}
          {% set b_start = [1, batch_page - b_show // 2] | max %}
          {% set b_end = [batch_pages, b_start + b_show - 1] | min %}
          {% set b_start = [1, b_end - b_show + 1] | max %}

          {% if b_start > 1 %}
            <a href="{{ url_for('check_shipments', tab='batches', status=batch_status, page=1) }}">1</a>
            {% if b_start > 2 %}<span class="ellipsis">...</span>{% endif %}
          {% endif %}

          {% for p in range(b_start, b_end + 1) %}
            {% if p == batch_page %}
              <a href="#" class="current-page">{{ p }}</a>
            {% else %}
              <a href="{{ url_for('check_shipments', tab='batches', status=batch_status, page=p) }}">{{ p }}</a>
            {% endif %}
          {% endfor %}

          {% if b_end < batch_pages %}
            {% if b_end < batch_pages - 1 %}<span class="ellipsis">...</span>{% endif %}
            <a href="{{ url_for('check_shipments', tab='batches', status=batch_status, page=batch_pages) }}">{{ batch_pages }}</a>
          {% endif %}

          {# Next button #}
          <a href="{{ url_for('check_shipments', tab='batches', status=batch_status, page=batch_page+1) }}" class="{% if batch_page >= batch_pages %}disabled{% endif %}">Next â†’</a>
        </div>
      {% else %}
        <p style="color: #666; margin-top: 20px;">No batches found with status "{{ batch_status }}".</p>
      {% endif %}
    </div>

    <!-- Tab: All Shipments -->
    <div id="tab-shipments" class="tab-content {{ 'active' if current_tab == 'shipments' else '' }}">
      <p style="margin-bottom: 16px; color: #666;">
        Track shipments from ShipStation (last 90 days). Click tracking # or status for live details.
      </p>

      <div class="search-box">
        <form method="get" action="{{ url_for('check_shipments') }}">
          <input type="hidden" name="tab" value="shipments">
          <input type="text" name="search" placeholder="Search by customer name, order #, or tracking #..." value="{{ search_query }}" autofocus>
          <button type="submit" class="btn btn-search">ğŸ” Search</button>
          {% if search_query %}
            <a href="{{ url_for('check_shipments', tab='shipments') }}" style="margin-left: 8px; color: #534bc4;">Clear</a>
          {% endif %}
        </form>
      </div>

      {% if loading %}
        <div class="loading">
          <p>â³ Loading shipments from ShipStation...</p>
        </div>
      {% elif shipments %}
        <table>
          <thead>
            <tr>
              <th>Flag</th>
              <th>Order #</th>
              <th>Batch</th>
              <th>Customer</th>
              <th>Tracking #</th>
              <th>Carrier</th>
              <th>Ship Date</th>
              <th>Scanned?</th>
              <th>Status</th>
              <th>Last Activity</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for ship in shipments %}
              <tr data-tracking="{{ ship.tracking_number }}" {% if ship.is_cancelled %}class="cancelled-row"{% endif %}>
                <td>
                  {% if ship.is_cancelled %}
                    <span style="color: #952746; font-size: 1.3rem;" title="ORDER CANCELLED">ğŸš«</span>
                  {% elif ship.flag %}
                    {% if ship.flag_severity == 'critical' %}
                      <span class="flag-critical" title="{{ ship.flag_reason }}">ğŸš¨</span>
                    {% else %}
                      <span class="flag-warning" title="{{ ship.flag_reason }}">âš ï¸</span>
                    {% endif %}
                  {% else %}
                    <span class="flag-ok">âœ“</span>
                  {% endif %}
                </td>
                <td>
                  <a href="#" onclick="showOrderDetails('{{ ship.order_number }}'); return false;" class="customer-link">{{ ship.order_number }}</a>
                </td>
                <td>{{ ship.batch_number or '-' }}</td>
                <td>
                  {% if ship.customer_name %}
                    <a href="#" onclick="showOrderDetails('{{ ship.order_number }}'); return false;" class="customer-link">{{ ship.customer_name }}</a>
                  {% else %}
                    â€”
                  {% endif %}
                </td>
                <td style="font-family: monospace; font-size: 0.85rem;">
                  {% if ship.tracking_url %}
                    <a href="{{ ship.tracking_url }}" target="_blank" title="View tracking">{{ ship.tracking_number }}</a>
                  {% else %}
                    {{ ship.tracking_number }}
                  {% endif %}
                </td>
                <td>{{ ship.carrier }}</td>
                <td>{{ ship.ship_date }}</td>
                <td>
                  {% if ship.scanned %}
                    <span style="color: #199b76;">âœ“ {{ ship.scan_date }}</span>
                  {% else %}
                    <span style="color: #666;">â€”</span>
                  {% endif %}
                </td>
                <td class="status-cell">
                  {% if ship.tracking_url %}
                    <a href="{{ ship.tracking_url }}" target="_blank" style="text-decoration: none;">
                      <span class="status-badge status-{{ ship.ups_status }}">
                        {{ ship.ups_status_text }}
                      </span>
                    </a>
                  {% else %}
                    <span class="status-badge status-{{ ship.ups_status }}">
                      {{ ship.ups_status_text }}
                    </span>
                  {% endif %}
                  {# Progress bar based on status #}
                  {% set progress_class = {
                    'delivered': 'progress-100',
                    'almost_there': 'progress-90',
                    'in_transit': 'progress-50',
                    'checking': 'progress-25',
                    'hasnt_moved': 'progress-25',
                    'label_created': 'progress-10',
                    'exception': 'progress-exception',
                    'unknown': 'progress-0'
                  }.get(ship.ups_status, 'progress-0') %}
                  <div class="progress-bar"><div class="progress-bar-fill {{ progress_class }}"></div></div>
                </td>
                <td class="activity-cell" style="font-size: 0.85rem;">{{ ship.ups_last_activity }}</td>
                <td>
                  {% if ship.is_cancelled %}
                    <form method="post" action="{{ url_for('uncancel_order') }}" style="display:inline;">
                      <input type="hidden" name="order_number" value="{{ ship.order_number }}">
                      <button type="submit" class="btn-uncancel">âœ“ Restore</button>
                    </form>
                  {% else %}
                    <button type="button" class="btn-cancel" onclick="cancelOrder('{{ ship.order_number }}', '{{ ship.tracking_number }}')">ğŸš« Cancel</button>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        <div class="pagination">
          {# Previous button #}
          <a href="{{ prev_url }}" class="{% if not has_prev %}disabled{% endif %}">â† Prev</a>

          {# Page numbers #}
          {% set show_pages = 5 %}
          {% set start_page = [1, page - show_pages // 2] | max %}
          {% set end_page = [total_pages, start_page + show_pages - 1] | min %}
          {% set start_page = [1, end_page - show_pages + 1] | max %}

          {% if start_page > 1 %}
            <a href="{{ url_for('check_shipments', tab='shipments', page=1, search=search_query, per_page=per_page) }}">1</a>
            {% if start_page > 2 %}<span class="ellipsis">...</span>{% endif %}
          {% endif %}

          {% for p in range(start_page, end_page + 1) %}
            {% if p == page %}
              <a href="#" class="current-page">{{ p }}</a>
            {% else %}
              <a href="{{ url_for('check_shipments', tab='shipments', page=p, search=search_query, per_page=per_page) }}">{{ p }}</a>
            {% endif %}
          {% endfor %}

          {% if end_page < total_pages %}
            {% if end_page < total_pages - 1 %}<span class="ellipsis">...</span>{% endif %}
            <a href="{{ url_for('check_shipments', tab='shipments', page=total_pages, search=search_query, per_page=per_page) }}">{{ total_pages }}</a>
          {% endif %}

          {# Next button #}
          <a href="{{ next_url }}" class="{% if not has_next %}disabled{% endif %}">Next â†’</a>

          {# Per page selector #}
          <div class="per-page-select">
            <label>Show:</label>
            <select onchange="changePerPage(this.value)">
              <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
              <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
              <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
              <option value="500" {% if per_page == 500 %}selected{% endif %}>500</option>
            </select>
          </div>

          <span style="margin-left: 12px; color: #666;">({{ total_shipments }} total)</span>
        </div>
      {% else %}
        <p style="padding: 40px; text-align: center; color: #666;">
          {% if search_query %}
            No shipments found for "{{ search_query }}".
          {% else %}
            No shipped orders found in the last 90 days.
          {% endif %}
        </p>
      {% endif %}
    </div>

    <!-- Order Details Modal -->
    <div id="orderModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
      <div style="background: white; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; position: relative; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <div style="padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
          <h3 style="margin: 0; color: #333;" id="modalTitle">Order Details</h3>
          <button onclick="closeOrderModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">&times;</button>
        </div>
        <div id="modalContent" style="padding: 20px;">
          <p style="text-align: center; color: #666;">Loading...</p>
        </div>
        <div style="padding: 15px 20px; border-top: 1px solid #eee; text-align: right; background: #f9f9f9;">
          <button onclick="closeOrderModal()" style="padding: 8px 16px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
        </div>
      </div>
    </div>
{% endblock %}

{% block scripts %}
  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Live Tracking Auto-Refresh
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    let trackingPollInterval = null;
    const POLL_INTERVAL = 30000; // Poll every 30 seconds
    const trackingNumbers = [];

    // Collect all tracking numbers on the page
    function collectTrackingNumbers() {
      const rows = document.querySelectorAll('tbody tr[data-tracking]');
      rows.forEach(row => {
        const tracking = row.dataset.tracking;
        if (tracking && !trackingNumbers.includes(tracking)) {
          trackingNumbers.push(tracking);
        }
      });
      return trackingNumbers;
    }

    // Update tracking status in the UI
    function updateTrackingUI(trackingData) {
      Object.keys(trackingData).forEach(tracking => {
        const data = trackingData[tracking];
        const row = document.querySelector(`tr[data-tracking="${tracking}"]`);
        if (!row) return;

        // Update status badge
        const statusCell = row.querySelector('.status-cell');
        if (statusCell) {
          const badge = statusCell.querySelector('.status-badge');
          if (badge) {
            // Remove old status class and add new one
            badge.className = 'status-badge status-' + data.status;
            badge.textContent = data.status_text;
          }

          // Update progress bar
          const progressFill = statusCell.querySelector('.progress-bar-fill');
          if (progressFill) {
            const progressClasses = {
              'delivered': 'progress-100',
              'almost_there': 'progress-90',
              'in_transit': 'progress-50',
              'checking': 'progress-25',
              'hasnt_moved': 'progress-25',
              'label_created': 'progress-10',
              'exception': 'progress-exception',
              'unknown': 'progress-0'
            };
            progressFill.className = 'progress-bar-fill ' + (progressClasses[data.status] || 'progress-0');
          }
        }

        // Update last activity
        const activityCell = row.querySelector('.activity-cell');
        if (activityCell && data.last_location) {
          activityCell.textContent = data.last_location;
        }
      });
    }

    // Poll for tracking updates
    async function pollTrackingStatus() {
      if (trackingNumbers.length === 0) return;

      try {
        const response = await fetch('/api/tracking/status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tracking_numbers: trackingNumbers })
        });

        const data = await response.json();
        if (data.success && data.tracking) {
          updateTrackingUI(data.tracking);
          updateLastRefreshTime();
        }
      } catch (error) {
        console.error('Error polling tracking status:', error);
      }
    }

    // Update the "last updated" timestamp
    function updateLastRefreshTime() {
      const lastUpdate = document.getElementById('lastUpdate');
      if (lastUpdate) {
        const now = new Date();
        lastUpdate.textContent = 'Updated: ' + now.toLocaleTimeString();
      }
    }

    // Start polling when on shipments tab
    function startTrackingPoll() {
      if (trackingPollInterval) return;
      collectTrackingNumbers();
      if (trackingNumbers.length > 0) {
        trackingPollInterval = setInterval(pollTrackingStatus, POLL_INTERVAL);
        // Also poll immediately on start
        pollTrackingStatus();
      }
    }

    // Stop polling
    function stopTrackingPoll() {
      if (trackingPollInterval) {
        clearInterval(trackingPollInterval);
        trackingPollInterval = null;
      }
    }

    // Initialize polling on page load if on shipments tab
    document.addEventListener('DOMContentLoaded', function() {
      const shipmentsTab = document.getElementById('tab-shipments');
      if (shipmentsTab && shipmentsTab.classList.contains('active')) {
        startTrackingPoll();
      }

      // Handle visibility change - pause polling when tab not visible
      document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
          stopTrackingPoll();
        } else {
          const shipmentsTab = document.getElementById('tab-shipments');
          if (shipmentsTab && shipmentsTab.classList.contains('active')) {
            startTrackingPoll();
          }
        }
      });
    });

    // Force refresh tracking for visible shipments
    async function forceRefreshTracking() {
      const btn = document.querySelector('.btn-refresh');
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'ğŸ”„ Refreshing...';
      }

      try {
        const response = await fetch('/api/tracking/refresh', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tracking_numbers: trackingNumbers.slice(0, 30) })
        });

        const data = await response.json();
        if (data.success) {
          // Wait a moment for cache to update, then poll
          setTimeout(pollTrackingStatus, 2000);
        }
      } catch (error) {
        console.error('Error refreshing tracking:', error);
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'ğŸ”„ Refresh Tracking';
        }
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Order Details Modal
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function showOrderDetails(orderNumber) {
      const modal = document.getElementById('orderModal');
      const modalContent = document.getElementById('modalContent');
      const modalTitle = document.getElementById('modalTitle');

      modal.style.display = 'flex';
      modalTitle.textContent = `Order #${orderNumber}`;
      modalContent.innerHTML = '<p style="text-align: center; color: #666;">Loading...</p>';

      try {
        const response = await fetch(`/api/orders/${orderNumber}/details`);
        const data = await response.json();

        if (data.success) {
          const order = data.order;
          const items = data.line_items;

          let addressHtml = '';
          const addr = order.shipping_address;
          if (addr && Object.keys(addr).length > 0) {
            if (addr.raw) {
              addressHtml = `<p style="margin: 0; line-height: 1.6;">${addr.raw}</p>`;
            } else {
              addressHtml = `
                <p style="margin: 0; line-height: 1.6;">
                  ${addr.name || ''}<br>
                  ${addr.address1 || ''}${addr.address2 ? '<br>' + addr.address2 : ''}<br>
                  ${addr.city || ''}, ${addr.province_code || addr.province || ''} ${addr.zip || ''}<br>
                  ${addr.country || ''}
                  ${addr.phone ? '<br>Phone: ' + addr.phone : ''}
                </p>
              `;
            }
          } else {
            addressHtml = '<p style="color: #999;">No shipping address</p>';
          }

          let itemsHtml = '';
          if (items && items.length > 0) {
            itemsHtml = items.map(item => {
              let propsHtml = '';
              if (item.properties && item.properties.length > 0) {
                propsHtml = '<div style="margin-top: 6px; padding: 6px 8px; background: #f8f9fa; border-radius: 4px; font-size: 0.85em;">' +
                  item.properties.map(p => `<div style="color: #555;"><span style="color: #888;">${p.name}:</span> ${p.value}</div>`).join('') +
                  '</div>';
              }
              return `
              <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                <div style="flex: 1;">
                  <strong>${item.title}</strong>
                  ${item.variant ? '<br><span style="color: #666; font-size: 0.9em;">' + item.variant + '</span>' : ''}
                  ${item.sku ? '<br><span style="color: #999; font-size: 0.85em;">SKU: ' + item.sku + '</span>' : ''}
                  ${propsHtml}
                </div>
                <div style="text-align: right; white-space: nowrap; margin-left: 12px;">
                  <span style="color: #666;">Ã— ${item.quantity}</span>
                  <br><strong>$${item.price.toFixed(2)}</strong>
                </div>
              </div>
            `}).join('');
          } else {
            itemsHtml = '<p style="color: #999;">No items found</p>';
          }

          modalContent.innerHTML = `
            <div style="margin-bottom: 20px;">
              <h4 style="margin: 0 0 10px 0; color: #666; font-size: 0.9rem; text-transform: uppercase;">Customer</h4>
              <p style="margin: 0;"><strong>${order.customer_name || 'Unknown'}</strong></p>
              <p style="margin: 4px 0; color: #666;">${order.customer_email || ''}</p>
              ${order.customer_phone ? '<p style="margin: 4px 0; color: #666;">' + order.customer_phone + '</p>' : ''}
            </div>

            <div style="margin-bottom: 20px;">
              <h4 style="margin: 0 0 10px 0; color: #666; font-size: 0.9rem; text-transform: uppercase;">Shipping Address</h4>
              ${addressHtml}
            </div>

            <div style="margin-bottom: 20px;">
              <h4 style="margin: 0 0 10px 0; color: #666; font-size: 0.9rem; text-transform: uppercase;">Items Ordered</h4>
              ${itemsHtml}
            </div>

            <div style="background: #f5f5f5; padding: 12px; border-radius: 4px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span>Subtotal:</span><span>$${order.subtotal_price.toFixed(2)}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span>Tax:</span><span>$${order.total_tax.toFixed(2)}</span>
              </div>
              <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.1em; border-top: 1px solid #ddd; padding-top: 8px; margin-top: 8px;">
                <span>Total:</span><span>$${order.total_price.toFixed(2)}</span>
              </div>
            </div>

            ${order.note ? '<div style="margin-top: 15px; padding: 10px; background: #fff8e1; border-radius: 4px;"><strong>Note:</strong> ' + order.note + '</div>' : ''}
            ${order.cancelled ? '<div style="margin-top: 15px; padding: 10px; background: #ffebee; border-radius: 4px; color: #c62828;"><strong>âš  This order has been cancelled</strong></div>' : ''}
          `;

        } else {
          modalContent.innerHTML = `<p style="text-align: center; color: #c62828;">Error: ${data.error || 'Could not load order'}</p>`;
        }
      } catch (error) {
        console.error('Error loading order:', error);
        modalContent.innerHTML = '<p style="text-align: center; color: #c62828;">Error loading order details</p>';
      }
    }

    function closeOrderModal() {
      document.getElementById('orderModal').style.display = 'none';
    }

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeOrderModal();
      }
    });

    document.getElementById('orderModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeOrderModal();
      }
    });

    function switchTab(tab) {
      // Update URL with tab parameter
      const url = new URL(window.location.href);
      url.searchParams.set('tab', tab);
      // Reset page when switching tabs
      url.searchParams.delete('page');
      window.location.href = url.toString();
    }

    function changePerPage(value) {
      const url = new URL(window.location.href);
      url.searchParams.set('per_page', value);
      url.searchParams.set('page', '1');  // Reset to page 1
      window.location.href = url.toString();
    }

    function cancelOrder(orderNumber, trackingNumber) {
      const reason = prompt("Reason for cancellation:", "Customer requested cancellation");
      if (reason !== null) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = "{{ url_for('cancel_order') }}";

        const orderInput = document.createElement('input');
        orderInput.type = 'hidden';
        orderInput.name = 'order_number';
        orderInput.value = orderNumber;
        form.appendChild(orderInput);

        const trackingInput = document.createElement('input');
        trackingInput.type = 'hidden';
        trackingInput.name = 'tracking_number';
        trackingInput.value = trackingNumber;
        form.appendChild(trackingInput);

        const reasonInput = document.createElement('input');
        reasonInput.type = 'hidden';
        reasonInput.name = 'reason';
        reasonInput.value = reason;
        form.appendChild(reasonInput);

        document.body.appendChild(form);
        form.submit();
      }
    }
  </script>
{% endblock %}
