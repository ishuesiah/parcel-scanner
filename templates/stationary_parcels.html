{% extends "base.html" %}
{% from "macros.html" import tracking_link, flag_icon %}

{% block title %}Parcels Not Moving - H&O Parcel Scans{% endblock %}

{% block extra_styles %}
<style>
  .severity-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
    display: inline-block;
    white-space: nowrap;
  }
  .severity-badge.critical {
    background: #ffebee;
    color: #c62828;
  }
  .severity-badge.warning {
    background: #fff8e1;
    color: #f57c00;
  }
  .days-counter {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.9rem;
  }
  .days-counter.critical {
    background: #ffebee;
    color: #c62828;
  }
  .days-counter.warning {
    background: #fff8e1;
    color: #f57c00;
  }
  .summary-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 16px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .summary-card .icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4rem;
  }
  .summary-card .icon.warning { background: #fff8e1; }
  .summary-card .icon.critical { background: #ffebee; }
  .summary-card .count {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-main);
  }
  .summary-card .label {
    font-size: 0.85rem;
    color: var(--text-muted);
  }
  .filter-pills {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .filter-pill {
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.2s;
    border: 1px solid var(--border-color);
    background: var(--bg-surface);
    color: var(--text-muted);
  }
  .filter-pill:hover {
    border-color: var(--secondary);
    color: var(--secondary);
  }
  .filter-pill.active {
    background: var(--secondary);
    color: white;
    border-color: var(--secondary);
  }
  .table-row-critical {
    background: rgba(198, 40, 40, 0.03);
  }
  .table-row-critical:hover {
    background: rgba(198, 40, 40, 0.08) !important;
  }
</style>
{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
  <div>
    <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
      <span style="font-size: 1.5rem;">&#128683;</span> Parcels Not Moving
    </h2>
    <p style="margin: 4px 0 0 0; color: var(--text-muted); font-size: 0.9rem;">
      Shipments with no tracking updates for {{ days_threshold }}+ days (still showing "Label Created")
    </p>
  </div>
  <a href="{{ url_for('check_shipments', tab='shipments') }}" class="btn btn-secondary" style="text-decoration: none;">
    View All Shipments
  </a>
</div>

<!-- Summary Cards -->
<div style="display: flex; gap: 16px; margin-bottom: 24px; flex-wrap: wrap;">
  <div class="summary-card">
    <div class="icon warning">&#9888;</div>
    <div>
      <div class="count">{{ total_parcels }}</div>
      <div class="label">Total Stuck Parcels</div>
    </div>
  </div>
  <div class="summary-card">
    <div class="icon critical">&#128680;</div>
    <div>
      <div class="count">{{ parcels | selectattr('severity', 'equalto', 'critical') | list | length }}</div>
      <div class="label">Critical (14+ days)</div>
    </div>
  </div>
</div>

<!-- Filter and Search -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
  <div class="filter-pills">
    <a href="{{ url_for('stationary_parcels', days=10, search=search_query, per_page=per_page) }}"
       class="filter-pill {% if days_threshold == 10 %}active{% endif %}">10+ days</a>
    <a href="{{ url_for('stationary_parcels', days=14, search=search_query, per_page=per_page) }}"
       class="filter-pill {% if days_threshold == 14 %}active{% endif %}">14+ days</a>
    <a href="{{ url_for('stationary_parcels', days=21, search=search_query, per_page=per_page) }}"
       class="filter-pill {% if days_threshold == 21 %}active{% endif %}">21+ days</a>
    <a href="{{ url_for('stationary_parcels', days=30, search=search_query, per_page=per_page) }}"
       class="filter-pill {% if days_threshold == 30 %}active{% endif %}">30+ days</a>
  </div>

  <div class="search-box" style="margin: 0;">
    <form method="get" action="{{ url_for('stationary_parcels') }}" style="display: flex; gap: 8px;">
      <input type="hidden" name="days" value="{{ days_threshold }}">
      <input type="hidden" name="per_page" value="{{ per_page }}">
      <input type="text" name="search" placeholder="Search order #, customer, tracking..." value="{{ search_query }}" style="min-width: 260px;">
      <button type="submit" class="btn btn-search">Search</button>
      {% if search_query %}
        <a href="{{ url_for('stationary_parcels', days=days_threshold, per_page=per_page) }}" class="btn btn-secondary">Clear</a>
      {% endif %}
    </form>
  </div>
</div>

{% if parcels %}
  <table>
    <thead>
      <tr>
        <th style="width: 50px;">Flag</th>
        <th>Days Stuck</th>
        <th>Order #</th>
        <th>Customer</th>
        <th>Tracking #</th>
        <th>Carrier</th>
        <th>Ship Date</th>
        <th>Scanned?</th>
        <th>Last Location</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for parcel in parcels %}
        <tr class="{% if parcel.severity == 'critical' %}table-row-critical{% endif %}">
          <td style="text-align: center;">
            {% if parcel.severity == 'critical' %}
              <span class="flag-critical" title="{{ parcel.flag_text }}">&#128680;</span>
            {% else %}
              <span class="flag-warning" title="{{ parcel.flag_text }}">&#9888;</span>
            {% endif %}
          </td>
          <td>
            <span class="days-counter {{ parcel.severity }}">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
              </svg>
              {{ parcel.days_since_ship }} days
            </span>
          </td>
          <td>
            <a href="#" onclick="showOrderDetails('{{ parcel.order_number }}'); return false;" class="customer-link">
              {{ parcel.order_number }}
            </a>
          </td>
          <td>
            <a href="#" onclick="showOrderDetails('{{ parcel.order_number }}'); return false;" class="customer-link">
              {{ parcel.customer_name }}
            </a>
          </td>
          <td>{{ tracking_link(parcel.tracking_number, parcel.carrier) }}</td>
          <td>{{ parcel.carrier }}</td>
          <td>{{ parcel.ship_date }}</td>
          <td style="text-align: center;">
            {% if parcel.scanned %}
              <span style="color: #199b76;">&#10003; {{ parcel.scan_date }}</span>
            {% else %}
              <span style="color: #666;">&#8212;</span>
            {% endif %}
          </td>
          <td style="font-size: 0.85rem; color: var(--text-muted);">{{ parcel.last_location }}</td>
          <td>
            {% if parcel.tracking_url %}
              <a href="{{ parcel.tracking_url }}" target="_blank" rel="noopener" class="btn btn-search" style="font-size: 0.8rem; padding: 6px 10px;">
                Track
              </a>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Pagination -->
  <div class="pagination">
    <a href="{{ prev_url }}" class="{% if not has_prev %}disabled{% endif %}">&#8592; Prev</a>

    {% set show_pages = 5 %}
    {% set start_page = [1, page - show_pages // 2] | max %}
    {% set end_page = [total_pages, start_page + show_pages - 1] | min %}
    {% set start_page = [1, end_page - show_pages + 1] | max %}

    {% if start_page > 1 %}
      <a href="{{ url_for('stationary_parcels', page=1, search=search_query, per_page=per_page, days=days_threshold) }}">1</a>
      {% if start_page > 2 %}<span class="ellipsis">...</span>{% endif %}
    {% endif %}

    {% for p in range(start_page, end_page + 1) %}
      {% if p == page %}
        <a href="#" class="current-page">{{ p }}</a>
      {% else %}
        <a href="{{ url_for('stationary_parcels', page=p, search=search_query, per_page=per_page, days=days_threshold) }}">{{ p }}</a>
      {% endif %}
    {% endfor %}

    {% if end_page < total_pages %}
      {% if end_page < total_pages - 1 %}<span class="ellipsis">...</span>{% endif %}
      <a href="{{ url_for('stationary_parcels', page=total_pages, search=search_query, per_page=per_page, days=days_threshold) }}">{{ total_pages }}</a>
    {% endif %}

    <a href="{{ next_url }}" class="{% if not has_next %}disabled{% endif %}">Next &#8594;</a>

    <div class="per-page-select">
      <label>Show:</label>
      <select onchange="changePerPage(this.value)">
        <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
        <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
        <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
        <option value="500" {% if per_page == 500 %}selected{% endif %}>500</option>
      </select>
    </div>

    <span style="margin-left: 12px; color: #666;">({{ total_parcels }} total)</span>
  </div>
{% else %}
  <div style="text-align: center; padding: 60px 20px; background: var(--bg-surface); border-radius: 12px; border: 1px solid var(--border-color);">
    <div style="font-size: 3rem; margin-bottom: 16px;">&#127881;</div>
    <h3 style="margin: 0 0 8px 0; color: var(--text-main);">No Stuck Parcels Found</h3>
    <p style="margin: 0; color: var(--text-muted);">
      {% if search_query %}
        No parcels matching "{{ search_query }}" have been stuck for {{ days_threshold }}+ days.
      {% else %}
        Great news! No parcels have been stuck at "Label Created" for {{ days_threshold }}+ days.
      {% endif %}
    </p>
  </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
  function changePerPage(value) {
    const url = new URL(window.location.href);
    url.searchParams.set('per_page', value);
    url.searchParams.set('page', '1');
    window.location.href = url.toString();
  }

  // Use the unified OrderPanel from base.html
  function showOrderDetails(orderNumber) {
    if (typeof OrderPanel !== 'undefined') {
      OrderPanel.open(orderNumber);
    } else {
      console.error('OrderPanel not loaded');
    }
  }
</script>
{% endblock %}
