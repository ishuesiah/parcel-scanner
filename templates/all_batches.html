{% extends "base.html" %}

{% block title %}All Batches - H&O Parcel Scans{% endblock %}

{% block extra_styles %}
    .batch-link { color: #2d85f8; text-decoration: none; font-weight: 500; }
    .batch-link:hover { text-decoration: underline; }
    .btn-delete-small {
      padding: 4px 8px; font-size: 0.8rem; background-color: #952746; color: #fff;
      border: none; border-radius: 4px; cursor: pointer;
    }
    .btn-delete-small:hover { opacity: 0.92; }

    /* Active batches section styling */
    .active-batches-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .active-batches-section h2 {
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .active-badge {
      background-color: #e3f2fd;
      color: #1976d2;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    /* Empty state styling */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }
    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 12px;
    }
    .empty-state h3 {
      font-size: 1.1rem;
      color: #333;
      margin-bottom: 16px;
    }
    .btn-create-batch {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background-color: #534bc4;
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 500;
      transition: all 0.2s;
    }
    .btn-create-batch:hover {
      opacity: 0.92;
      transform: translateY(-1px);
    }

    /* Active batch cards */
    .active-batch-card {
      background: #f8f9ff;
      border: 1px solid #e0e4ff;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
    }
    .active-batch-card:hover {
      background: #f0f2ff;
      border-color: #c5caff;
    }
    .batch-card-info h3 {
      font-size: 1.1rem;
      margin-bottom: 4px;
    }
    .batch-card-info h3 a {
      color: #333;
      text-decoration: none;
    }
    .batch-card-info h3 a:hover {
      color: #534bc4;
    }
    .batch-card-meta {
      font-size: 0.85rem;
      color: #666;
      display: flex;
      gap: 16px;
    }
    .batch-card-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .btn-resume {
      background-color: #199b76;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      text-decoration: none;
      font-size: 0.85rem;
      font-weight: 500;
    }
    .btn-resume:hover {
      opacity: 0.92;
    }
    .btn-picked-up {
      background-color: #f39c12;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      border: none;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
    }
    .btn-picked-up:hover {
      opacity: 0.92;
    }

    /* Bulk actions bar */
    .bulk-actions-bar {
      background: #fff4e5;
      border: 1px solid #ffe0b2;
      border-radius: 6px;
      padding: 12px 16px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .bulk-actions-bar label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-weight: 500;
    }
    .bulk-actions-bar input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .selected-count {
      color: #8a6100;
      font-size: 0.9rem;
    }
    .btn-bulk-action {
      background: #f39c12;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.9rem;
    }
    .btn-bulk-action:hover {
      opacity: 0.92;
    }
    .btn-bulk-action:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .batch-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
      margin-right: 12px;
    }
    .batch-card-with-checkbox {
      display: flex;
      align-items: center;
    }

    /* Completed batches section */
    .completed-batches-section {
      margin-top: 24px;
    }
    .completed-batches-section h2 {
      color: #666;
      font-size: 1.2rem;
      margin-bottom: 12px;
    }
{% endblock %}

{% block content %}
    <!-- Active Batches Section -->
    <div class="active-batches-section">
      <h2>
        Active Batches
        {% if active_batches %}
          <span class="active-badge">{{ active_batches|length }}</span>
        {% endif %}
      </h2>

      {% if active_batches %}
        <!-- Bulk Actions Bar -->
        <div class="bulk-actions-bar">
          <label>
            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
            Select All
          </label>
          <span class="selected-count" id="selectedCount">0 selected</span>
          <button type="button" class="btn-bulk-action" id="bulkMarkBtn" onclick="bulkMarkPickedUp()" disabled>
            Mark Selected as Picked Up
          </button>
        </div>

        <form id="bulkForm" action="{{ url_for('bulk_mark_picked_up') }}" method="post">
          {% for b in active_batches %}
            <div class="active-batch-card batch-card-with-checkbox">
              <input type="checkbox" name="batch_ids" value="{{ b.id }}" class="batch-checkbox" onchange="updateSelectedCount()">
              <div class="batch-card-info" style="flex: 1;">
                <h3>
                  <a href="{{ url_for('view_batch', batch_id=b.id) }}">
                    Batch #{{ b.id }}
                  </a>
                </h3>
                <div class="batch-card-meta">
                  <span>{{ b.carrier }}</span>
                  <span>{{ b.pkg_count }} packages</span>
                  <span>Started {{ b.created_at }}</span>
                  {% if b.notes %}
                    <span style="color: #534bc4;">{{ b.notes }}</span>
                  {% endif %}
                </div>
              </div>
              <div class="batch-card-actions">
                <button type="button" class="btn-picked-up" title="Mark as picked up to move to Completed"
                        onclick="markSinglePickedUp({{ b.id }})">
                  Mark Picked Up
                </button>
                <a href="{{ url_for('edit_batch', batch_id=b.id) }}" class="btn-resume">
                  Resume Scanning
                </a>
                <button type="button" class="btn-delete-small"
                        onclick="if(confirm('Are you sure you want to delete batch #{{ b.id }}? This will remove all associated scans.')) { deleteBatch({{ b.id }}); }">
                  Delete
                </button>
              </div>
            </div>
          {% endfor %}
        </form>
      {% else %}
        <div class="empty-state">
          <div class="empty-state-icon">üì¶</div>
          <h3>No active batches currently</h3>
          <a href="{{ url_for('new_batch') }}" class="btn-create-batch">
            + Create New Batch
          </a>
        </div>
      {% endif %}
    </div>

    <!-- Completed Batches Section -->
    <div class="completed-batches-section">
      <h2>Completed Batches</h2>
      {% if completed_batches %}
        <table>
          <thead>
            <tr>
              <th>Batch ID</th>
              <th>Carrier</th>
              <th>Created At</th>
              <th>Pkg Count</th>
              <th>Status</th>
              <th>Notes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for b in completed_batches %}
              <tr>
                <td>
                  <a class="batch-link" href="{{ url_for('view_batch', batch_id=b.id) }}">
                    Batch {{ b.id }}
                  </a>
                </td>
                <td>{{ b.carrier }}</td>
                <td>{{ b.created_at }}</td>
                <td>{{ b.pkg_count }}</td>
                <td>
                  {% set batch_status = b.get('status', 'in_progress') %}
                  {% if batch_status == 'notified' %}
                    <span style="color: #199b76; font-weight: 500;">‚úâ Notified</span>
                  {% elif batch_status == 'recorded' %}
                    <span style="color: #f39c12; font-weight: 500;">‚úì Picked Up</span>
                  {% else %}
                    <span style="color: #666;">‚è≥ In Progress</span>
                  {% endif %}
                </td>
                <td>{{ b.notes or '‚Äî' }}</td>
                <td>
                  <form action="{{ url_for('delete_batch') }}" method="post" style="display: inline;"
                        onsubmit="return confirm('Are you sure you want to delete batch #{{ b.id }}? This will remove all associated scans.');">
                    <input type="hidden" name="batch_id" value="{{ b.id }}">
                    <button type="submit" class="btn-delete-small">Delete</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p style="color: #999; padding: 20px 0;">No completed batches yet.</p>
      {% endif %}
    </div>

    <!-- Hidden forms for single actions -->
    <form id="singleMarkForm" action="{{ url_for('mark_batch_picked_up') }}" method="post" style="display: none;">
      <input type="hidden" name="batch_id" id="singleMarkBatchId">
    </form>
    <form id="deleteForm" action="{{ url_for('delete_batch') }}" method="post" style="display: none;">
      <input type="hidden" name="batch_id" id="deleteBatchId">
    </form>
{% endblock %}

{% block scripts %}
<script>
  function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.batch-checkbox');
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
    updateSelectedCount();
  }

  function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.batch-checkbox:checked');
    const count = checkboxes.length;
    document.getElementById('selectedCount').textContent = count + ' selected';
    document.getElementById('bulkMarkBtn').disabled = count === 0;

    // Update select all checkbox state
    const allCheckboxes = document.querySelectorAll('.batch-checkbox');
    const selectAll = document.getElementById('selectAll');
    if (count === 0) {
      selectAll.checked = false;
      selectAll.indeterminate = false;
    } else if (count === allCheckboxes.length) {
      selectAll.checked = true;
      selectAll.indeterminate = false;
    } else {
      selectAll.checked = false;
      selectAll.indeterminate = true;
    }
  }

  function bulkMarkPickedUp() {
    const checkboxes = document.querySelectorAll('.batch-checkbox:checked');
    if (checkboxes.length === 0) {
      alert('Please select at least one batch.');
      return;
    }

    if (confirm('Mark ' + checkboxes.length + ' batches as picked up?')) {
      document.getElementById('bulkForm').submit();
    }
  }

  function markSinglePickedUp(batchId) {
    document.getElementById('singleMarkBatchId').value = batchId;
    document.getElementById('singleMarkForm').submit();
  }

  function deleteBatch(batchId) {
    document.getElementById('deleteBatchId').value = batchId;
    document.getElementById('deleteForm').submit();
  }
</script>
{% endblock %}
