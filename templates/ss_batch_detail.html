{% extends "base.html" %}

{% block title %}Batch {{ batch_id }} - H&O Parcel Scans{% endblock %}

{% block extra_styles %}
    .back-link { color: #534bc4; text-decoration: none; margin-bottom: 16px; display: inline-block; }
    .back-link:hover { text-decoration: underline; }

    .batch-info-box {
      background: white; padding: 16px; border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px;
    }
    .batch-info-box p { margin: 4px 0; color: #666; }
    .batch-info-box strong { color: #333; }

    .tracking-link { color: #534bc4; text-decoration: none; }
    .tracking-link:hover { text-decoration: underline; }

    .status-badge {
      display: inline-block; padding: 4px 8px; border-radius: 4px;
      font-size: 0.85rem; font-weight: 500;
    }
    .status-label_created { background-color: #e3f2fd; color: #1976d2; }
    .status-in_transit { background-color: #fff4e5; color: #8a6100; }
    .status-delivered { background-color: #e0f7e9; color: #199b76; }
    .status-almost_there { background-color: #d4edda; color: #155724; font-weight: 600; }
    .status-exception { background-color: #fdecea; color: #952746; }
    .status-unknown { background-color: #f5f5f5; color: #666; }

    .summary-stats {
      display: flex; gap: 16px; margin-bottom: 16px; flex-wrap: wrap;
    }
    .stat-box {
      background: white; padding: 12px 20px; border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .stat-box .label { font-size: 0.85rem; color: #666; }
    .stat-box .value { font-size: 1.5rem; font-weight: 600; color: #2c3e50; }
{% endblock %}

{% block content %}
    <a href="{{ url_for('check_shipments', tab='batches') }}" class="back-link">&larr; Back to Live Tracking</a>
    <h2>Batch {{ batch_id.replace('se-', '') if batch_id else batch_id }}</h2>

    {% if batch %}
      <div class="batch-info-box">
        <p><strong>Notes:</strong> {{ batch.batch_notes or 'None' }}</p>
        <p><strong>Created:</strong> {{ batch.created_at }}</p>
        <p><strong>Status:</strong> {{ batch.status }}</p>
        <p><strong>Total Shipments:</strong> {{ batch.count }}</p>
        {% if batch.errors %}
          <p><strong>Errors:</strong> {{ batch.errors }}</p>
        {% endif %}
      </div>
    {% endif %}

    <div class="summary-stats">
      <div class="stat-box">
        <div class="label">Total</div>
        <div class="value">{{ shipments|length }}</div>
      </div>
      <div class="stat-box">
        <div class="label">Delivered</div>
        <div class="value" style="color: #199b76;">{{ stats.delivered }}</div>
      </div>
      <div class="stat-box">
        <div class="label">In Transit</div>
        <div class="value" style="color: #8a6100;">{{ stats.in_transit }}</div>
      </div>
      <div class="stat-box">
        <div class="label">Not Moving</div>
        <div class="value" style="color: #952746;">{{ stats.not_moving }}</div>
      </div>
    </div>

    {% if shipments %}
      <table>
        <thead>
          <tr>
            <th>Tracking #</th>
            <th>Order</th>
            <th>Customer</th>
            <th>Carrier</th>
            <th>Ship Date</th>
            <th>Status</th>
            <th>Location</th>
          </tr>
        </thead>
        <tbody>
          {% for s in shipments %}
            <tr>
              <td>
                {% if s.carrier_code == 'UPS' or s.tracking_number.startswith('1Z') %}
                  <a class="tracking-link" href="https://www.ups.com/track?loc=en_US&tracknum={{ s.tracking_number }}" target="_blank">{{ s.tracking_number }}</a>
                {% elif 'canada' in (s.carrier_code or '')|lower %}
                  <a class="tracking-link" href="https://www.canadapost-postescanada.ca/track-reperage/en#/search?searchFor={{ s.tracking_number }}" target="_blank">{{ s.tracking_number }}</a>
                {% else %}
                  {{ s.tracking_number }}
                {% endif %}
              </td>
              <td>{{ s.order_number or '-' }}</td>
              <td>{{ s.customer_name or '-' }}</td>
              <td>{{ s.carrier_code or '-' }}</td>
              <td>{{ s.ship_date or '-' }}</td>
              <td>
                <span class="status-badge status-{{ s.tracking_status or 'unknown' }}">
                  {{ s.tracking_status_text or 'Unknown' }}
                </span>
              </td>
              <td>{{ s.last_location or '-' }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p style="color: #666; margin-top: 20px;">No shipments found in this batch.</p>
    {% endif %}
{% endblock %}
