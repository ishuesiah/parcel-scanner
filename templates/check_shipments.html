{% extends "base.html" %}
{% from "macros.html" import tracking_link %}

{% block title %}Live Tracking - H&O Parcel Scans{% endblock %}

{% block extra_styles %}
<style>
  /* Tracking Groups Styles */
  .groups-container {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    margin-bottom: 20px;
  }
  .group-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 16px 20px;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 180px;
  }
  .group-card:hover {
    border-color: var(--secondary);
    box-shadow: 0 2px 8px rgba(81, 106, 236, 0.1);
  }
  .group-card.selected {
    border-color: var(--secondary);
    background: rgba(81, 106, 236, 0.05);
  }
  .group-card h4 {
    margin: 0 0 4px 0;
    font-size: 1rem;
  }
  .group-card .order-count {
    font-size: 0.85rem;
    color: var(--text-muted);
  }
  .btn-new-group {
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 16px 24px;
    cursor: pointer;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
  }
  .btn-new-group:hover {
    opacity: 0.9;
    transform: translateY(-1px);
  }
  .add-orders-box {
    background: var(--bg-surface);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
  }
  .add-orders-box textarea {
    width: 100%;
    min-height: 80px;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-family: inherit;
    resize: vertical;
    margin-bottom: 8px;
  }
  .group-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    flex-wrap: wrap;
    gap: 12px;
  }
  .group-header h3 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .group-actions {
    display: flex;
    gap: 8px;
  }
  .tracking-status-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
  }
  .tracking-status-badge.ok { background: #e8f5e9; color: #2e7d32; }
  .tracking-status-badge.warning { background: #fff8e1; color: #f57c00; }
  .tracking-status-badge.critical { background: #ffebee; color: #c62828; }
</style>
{% endblock %}

{% block content %}
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
      <h2>üì¶ Live Tracking</h2>
      <div style="display: flex; gap: 12px; align-items: center;">
        <button onclick="createNewGroup()" class="btn-new-group" style="padding: 10px 20px; font-size: 0.9rem;">
          + New tracking group
        </button>
        <a href="{{ url_for('check_shipments', page=page, tab=current_tab, status=batch_status, search=search_query, refresh='1') }}"
           class="btn btn-search" style="text-decoration: none;">üîÑ Refresh Tracking</a>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn {{ 'active' if current_tab == 'shipments' else '' }}" onclick="switchTab('shipments')">All Shipments</button>
      <button class="tab-btn {{ 'active' if current_tab == 'batches' else '' }}" onclick="switchTab('batches')">ShipStation Batches</button>
      {% for group in tracking_groups %}
        <button class="tab-btn {{ 'active' if current_tab == 'group_' ~ group.id|string else '' }}" onclick="switchTab('group_{{ group.id }}')">
          {{ group.name }}
          <span style="background: var(--secondary); color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem; margin-left: 4px;">{{ group.order_count }}</span>
        </button>
      {% endfor %}
    </div>

    <!-- Tab: Recent Batches -->
    <div id="tab-batches" class="tab-content {{ 'active' if current_tab == 'batches' else '' }}">
      <p style="margin-bottom: 16px; color: #666;">
        Recently processed ShipStation batches. Click a batch to see shipment details.
      </p>

      <div class="status-filters">
        <a href="{{ url_for('check_shipments', tab='batches', status='completed') }}" class="filter-btn {{ 'active' if batch_status == 'completed' else '' }}">Completed</a>
        <a href="{{ url_for('check_shipments', tab='batches', status='processing') }}" class="filter-btn {{ 'active' if batch_status == 'processing' else '' }}">Processing</a>
        <a href="{{ url_for('check_shipments', tab='batches', status='open') }}" class="filter-btn {{ 'active' if batch_status == 'open' else '' }}">Open</a>
        <a href="{{ url_for('check_shipments', tab='batches', status='queued') }}" class="filter-btn {{ 'active' if batch_status == 'queued' else '' }}">Queued</a>
      </div>

      {% if batch_error %}
        <div class="flash error">{{ batch_error }}</div>
      {% endif %}

      {% if batches %}
        <table>
          <thead>
            <tr>
              <th>Batch ID</th>
              <th>Created</th>
              <th>Count</th>
              <th>Status</th>
              <th>Errors</th>
            </tr>
          </thead>
          <tbody>
            {% for b in batches %}
              <tr>
                <td><a class="batch-link" href="{{ url_for('ss_batch_detail', batch_id=b.batch_id) }}">{{ b.batch_number or b.batch_id.replace('se-', '') if b.batch_id else '-' }}</a></td>
                <td>{{ b.created_at[:16] if b.created_at else '-' }}</td>
                <td>{{ b.count }}</td>
                <td><span class="status-badge status-{{ b.status }}">{{ b.status }}</span></td>
                <td>{{ b.errors or 0 }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        <div class="pagination">
          {# Previous button #}
          <a href="{{ url_for('check_shipments', tab='batches', status=batch_status, page=batch_page-1) }}" class="{% if batch_page <= 1 %}disabled{% endif %}">‚Üê Prev</a>

          {# Page numbers for batches #}
          {% set b_show = 5 %}
          {% set b_start = [1, batch_page - b_show // 2] | max %}
          {% set b_end = [batch_pages, b_start + b_show - 1] | min %}
          {% set b_start = [1, b_end - b_show + 1] | max %}

          {% if b_start > 1 %}
            <a href="{{ url_for('check_shipments', tab='batches', status=batch_status, page=1) }}">1</a>
            {% if b_start > 2 %}<span class="ellipsis">...</span>{% endif %}
          {% endif %}

          {% for p in range(b_start, b_end + 1) %}
            {% if p == batch_page %}
              <a href="#" class="current-page">{{ p }}</a>
            {% else %}
              <a href="{{ url_for('check_shipments', tab='batches', status=batch_status, page=p) }}">{{ p }}</a>
            {% endif %}
          {% endfor %}

          {% if b_end < batch_pages %}
            {% if b_end < batch_pages - 1 %}<span class="ellipsis">...</span>{% endif %}
            <a href="{{ url_for('check_shipments', tab='batches', status=batch_status, page=batch_pages) }}">{{ batch_pages }}</a>
          {% endif %}

          {# Next button #}
          <a href="{{ url_for('check_shipments', tab='batches', status=batch_status, page=batch_page+1) }}" class="{% if batch_page >= batch_pages %}disabled{% endif %}">Next ‚Üí</a>
        </div>
      {% else %}
        <p style="color: #666; margin-top: 20px;">No batches found with status "{{ batch_status }}".</p>
      {% endif %}
    </div>

    <!-- Tab: All Shipments -->
    <div id="tab-shipments" class="tab-content {{ 'active' if current_tab == 'shipments' else '' }}">
      <p style="margin-bottom: 16px; color: #666;">
        Track shipments from ShipStation (last 90 days). Click tracking # or status for live details.
      </p>

      <div class="search-box">
        <form method="get" action="{{ url_for('check_shipments') }}">
          <input type="hidden" name="tab" value="shipments">
          <input type="text" name="search" placeholder="Search by customer name, order #, or tracking #..." value="{{ search_query }}" autofocus>
          <button type="submit" class="btn btn-search">üîç Search</button>
          {% if search_query %}
            <a href="{{ url_for('check_shipments', tab='shipments') }}" style="margin-left: 8px; color: #534bc4;">Clear</a>
          {% endif %}
        </form>
      </div>

      {% if loading %}
        <div class="loading">
          <p>‚è≥ Loading shipments from ShipStation...</p>
        </div>
      {% elif shipments %}
        <table>
          <thead>
            <tr>
              <th>Flag</th>
              <th>Order #</th>
              <th>Batch</th>
              <th>Customer</th>
              <th>Tracking #</th>
              <th>Carrier</th>
              <th>Ship Date</th>
              <th>Scanned?</th>
              <th>Status</th>
              <th>Last Activity</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for ship in shipments %}
              <tr {% if ship.is_cancelled %}class="cancelled-row"{% endif %}>
                <td>
                  {% if ship.is_cancelled %}
                    <span style="color: #952746; font-size: 1.3rem;" title="ORDER CANCELLED">üö´</span>
                  {% elif ship.flag %}
                    {% if ship.flag_severity == 'critical' %}
                      <span class="flag-critical" title="{{ ship.flag_reason }}">üö®</span>
                    {% else %}
                      <span class="flag-warning" title="{{ ship.flag_reason }}">‚ö†Ô∏è</span>
                    {% endif %}
                  {% else %}
                    <span class="flag-ok">‚úì</span>
                  {% endif %}
                </td>
                <td>
                  <a href="#" onclick="showOrderDetails('{{ ship.order_number }}'); return false;" class="customer-link">{{ ship.order_number }}</a>
                </td>
                <td>{{ ship.batch_number or '-' }}</td>
                <td>
                  {% if ship.customer_name %}
                    <a href="#" onclick="showOrderDetails('{{ ship.order_number }}'); return false;" class="customer-link">{{ ship.customer_name }}</a>
                  {% else %}
                    ‚Äî
                  {% endif %}
                </td>
                <td>{{ tracking_link(ship.tracking_number, ship.carrier) }}</td>
                <td>{{ ship.carrier }}</td>
                <td>{{ ship.ship_date }}</td>
                <td>
                  {% if ship.scanned %}
                    <span style="color: #199b76;">‚úì {{ ship.scan_date }}</span>
                  {% else %}
                    <span style="color: #666;">‚Äî</span>
                  {% endif %}
                </td>
                <td>
                  {% if ship.tracking_url %}
                    <a href="{{ ship.tracking_url }}" target="_blank" style="text-decoration: none;">
                      <span class="status-badge status-{{ ship.ups_status }}">
                        {{ ship.ups_status_text }}
                      </span>
                    </a>
                  {% else %}
                    <span class="status-badge status-{{ ship.ups_status }}">
                      {{ ship.ups_status_text }}
                    </span>
                  {% endif %}
                  {# Progress bar based on status #}
                  {% set progress_class = {
                    'delivered': 'progress-100',
                    'almost_there': 'progress-90',
                    'in_transit': 'progress-50',
                    'checking': 'progress-25',
                    'hasnt_moved': 'progress-25',
                    'label_created': 'progress-10',
                    'exception': 'progress-exception',
                    'unknown': 'progress-0'
                  }.get(ship.ups_status, 'progress-0') %}
                  <div class="progress-bar"><div class="progress-bar-fill {{ progress_class }}"></div></div>
                </td>
                <td style="font-size: 0.85rem;">{{ ship.ups_last_activity }}</td>
                <td>
                  {% if ship.is_cancelled %}
                    <form method="post" action="{{ url_for('uncancel_order') }}" style="display:inline;">
                      <input type="hidden" name="order_number" value="{{ ship.order_number }}">
                      <button type="submit" class="btn-uncancel">‚úì Restore</button>
                    </form>
                  {% else %}
                    <button type="button" class="btn-cancel" onclick="cancelOrder('{{ ship.order_number }}', '{{ ship.tracking_number }}')">üö´ Cancel</button>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        <div class="pagination">
          {# Previous button #}
          <a href="{{ prev_url }}" class="{% if not has_prev %}disabled{% endif %}">‚Üê Prev</a>

          {# Page numbers #}
          {% set show_pages = 5 %}
          {% set start_page = [1, page - show_pages // 2] | max %}
          {% set end_page = [total_pages, start_page + show_pages - 1] | min %}
          {% set start_page = [1, end_page - show_pages + 1] | max %}

          {% if start_page > 1 %}
            <a href="{{ url_for('check_shipments', tab='shipments', page=1, search=search_query, per_page=per_page) }}">1</a>
            {% if start_page > 2 %}<span class="ellipsis">...</span>{% endif %}
          {% endif %}

          {% for p in range(start_page, end_page + 1) %}
            {% if p == page %}
              <a href="#" class="current-page">{{ p }}</a>
            {% else %}
              <a href="{{ url_for('check_shipments', tab='shipments', page=p, search=search_query, per_page=per_page) }}">{{ p }}</a>
            {% endif %}
          {% endfor %}

          {% if end_page < total_pages %}
            {% if end_page < total_pages - 1 %}<span class="ellipsis">...</span>{% endif %}
            <a href="{{ url_for('check_shipments', tab='shipments', page=total_pages, search=search_query, per_page=per_page) }}">{{ total_pages }}</a>
          {% endif %}

          {# Next button #}
          <a href="{{ next_url }}" class="{% if not has_next %}disabled{% endif %}">Next ‚Üí</a>

          {# Per page selector #}
          <div class="per-page-select">
            <label>Show:</label>
            <select onchange="changePerPage(this.value)">
              <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
              <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
              <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
              <option value="500" {% if per_page == 500 %}selected{% endif %}>500</option>
            </select>
          </div>

          <span style="margin-left: 12px; color: #666;">({{ total_shipments }} total)</span>
        </div>
      {% else %}
        <p style="padding: 40px; text-align: center; color: #666;">
          {% if search_query %}
            No shipments found for "{{ search_query }}".
          {% else %}
            No shipped orders found in the last 90 days.
          {% endif %}
        </p>
      {% endif %}
    </div>

    <!-- Tab: Ticket Tracking (Groups) -->
    <!-- Dynamic Group Tabs -->
    {% for group in tracking_groups %}
    <div id="tab-group_{{ group.id }}" class="tab-content {{ 'active' if current_tab == 'group_' ~ group.id|string else '' }}" data-group-id="{{ group.id }}">
      <!-- Group Header -->
      <div class="group-header" style="margin-bottom: 20px;">
        <div style="display: flex; align-items: center; gap: 16px;">
          <h3 style="margin: 0;">{{ group.name }}</h3>
          <button onclick="editGroupName({{ group.id }}, '{{ group.name }}')" style="background: none; border: none; cursor: pointer; font-size: 0.85rem; color: var(--secondary);">Rename</button>
        </div>
        <div class="group-actions">
          <button onclick="refreshGroupTracking({{ group.id }})" class="btn btn-search" style="font-size: 0.85rem;">üîÑ Refresh Status</button>
          <button onclick="deleteGroup({{ group.id }}, '{{ group.name }}')" class="btn-delete-small">Delete Group</button>
        </div>
      </div>

      <!-- Add Orders Box -->
      <div class="add-orders-box">
        <label style="font-weight: 500; margin-bottom: 8px; display: block;">Add Orders to Group</label>
        <div style="display: flex; gap: 12px; align-items: flex-start;">
          <input type="text" id="addOrdersInput_{{ group.id }}" placeholder="Enter order numbers (comma separated, e.g., 61234, 61235)" style="flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
          <button onclick="addOrdersToGroup({{ group.id }})" class="btn btn-search">Add</button>
        </div>
        <span id="addOrdersStatus_{{ group.id }}" style="color: #666; font-size: 0.85rem; margin-top: 6px; display: block;"></span>
      </div>

      <!-- Group Orders Table -->
      <div id="groupOrdersTable_{{ group.id }}">
        <table>
          <thead>
            <tr>
              <th style="width: 40px;">FLAG</th>
              <th>ORDER #</th>
              <th>BATCH</th>
              <th>CUSTOMER</th>
              <th>TRACKING #</th>
              <th>CARRIER</th>
              <th>SHIP DATE</th>
              <th>SCANNED?</th>
              <th>STATUS</th>
              <th>LAST ACTIVITY</th>
              <th>ACTION</th>
            </tr>
          </thead>
          <tbody id="groupOrdersBody_{{ group.id }}">
            <tr><td colspan="11" style="text-align: center; color: #666; padding: 40px;">Loading orders...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    {% endfor %}

    <!-- Create Group Modal -->
    <div id="createGroupModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
      <div style="background: white; border-radius: 12px; max-width: 500px; width: 90%; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <h3 style="margin: 0 0 16px 0;">Create New Tracking Group</h3>
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-weight: 500; margin-bottom: 6px;">Group Name *</label>
          <input type="text" id="newGroupName" placeholder="e.g., CS Ticket #12345" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-weight: 500; margin-bottom: 6px;">Description (optional)</label>
          <input type="text" id="newGroupDesc" placeholder="e.g., Lost package investigation" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-weight: 500; margin-bottom: 6px;">Order Numbers to Track</label>
          <textarea id="newGroupOrders" placeholder="Enter order numbers (comma or line separated)&#10;e.g., 59615, 61131, 59137, 60356" style="width: 100%; min-height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: inherit;"></textarea>
          <small style="color: #666;">You can add more orders after the group is created.</small>
        </div>
        <div style="display: flex; gap: 8px; justify-content: flex-end;">
          <button onclick="closeCreateGroupModal()" style="padding: 10px 20px; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>
          <button onclick="submitCreateGroup()" style="padding: 10px 20px; background: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Create Group</button>
        </div>
      </div>
    </div>
    <!-- Order Details: Now unified in base.html (OrderPanel) -->
{% endblock %}

{% block scripts %}
  <script>
    // ‚îÄ‚îÄ Tracking Link Helper ‚îÄ‚îÄ
    function trackingLink(trackingNumber, carrier) {
      if (!trackingNumber) return '<span style="color: #999;">‚Äî</span>';
      const isUps = carrier === 'UPS' || (trackingNumber && trackingNumber.startsWith('1Z'));
      const isCanadaPost = carrier && carrier.toLowerCase().includes('canada');
      const isFedex = carrier && carrier.toLowerCase().includes('fedex');
      const isUsps = carrier && carrier.toLowerCase().includes('usps');
      let url;
      if (isUps) {
        url = `https://www.ups.com/track?loc=en_US&tracknum=${trackingNumber}`;
      } else if (isCanadaPost) {
        url = `https://www.canadapost-postescanada.ca/track-reperage/en#/search?searchFor=${trackingNumber}`;
      } else if (isFedex) {
        url = `https://www.fedex.com/fedextrack/?trknbr=${trackingNumber}`;
      } else if (isUsps) {
        url = `https://tools.usps.com/go/TrackConfirmAction?tLabels=${trackingNumber}`;
      } else {
        url = `https://www.google.com/search?q=${trackingNumber}+tracking`;
      }
      return `<a href="${url}" target="_blank" rel="noopener" style="color: #1976d2; text-decoration: none; font-family: monospace; font-size: 0.85rem;" title="Track ${trackingNumber}">${trackingNumber}</a>`;
    }

    // Order Details: Now handled by unified OrderPanel (see order-panel.js)

    function switchTab(tab) {
      // Update URL with tab parameter
      const url = new URL(window.location.href);
      url.searchParams.set('tab', tab);
      // Reset page when switching tabs
      url.searchParams.delete('page');
      window.location.href = url.toString();
    }

    function changePerPage(value) {
      const url = new URL(window.location.href);
      url.searchParams.set('per_page', value);
      url.searchParams.set('page', '1');  // Reset to page 1
      window.location.href = url.toString();
    }

    function cancelOrder(orderNumber, trackingNumber) {
      const reason = prompt("Reason for cancellation:", "Customer requested cancellation");
      if (reason !== null) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = "{{ url_for('cancel_order') }}";

        const orderInput = document.createElement('input');
        orderInput.type = 'hidden';
        orderInput.name = 'order_number';
        orderInput.value = orderNumber;
        form.appendChild(orderInput);

        const trackingInput = document.createElement('input');
        trackingInput.type = 'hidden';
        trackingInput.name = 'tracking_number';
        trackingInput.value = trackingNumber;
        form.appendChild(trackingInput);

        const reasonInput = document.createElement('input');
        reasonInput.type = 'hidden';
        reasonInput.name = 'reason';
        reasonInput.value = reason;
        form.appendChild(reasonInput);

        document.body.appendChild(form);
        form.submit();
      }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Tracking Groups Functions
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    let currentGroupId = null;

    function createNewGroup() {
      document.getElementById('createGroupModal').style.display = 'flex';
      document.getElementById('newGroupName').value = '';
      document.getElementById('newGroupDesc').value = '';
      document.getElementById('newGroupOrders').value = '';
      document.getElementById('newGroupName').focus();
    }

    function closeCreateGroupModal() {
      document.getElementById('createGroupModal').style.display = 'none';
    }

    async function submitCreateGroup() {
      const name = document.getElementById('newGroupName').value.trim();
      const description = document.getElementById('newGroupDesc').value.trim();
      const ordersText = document.getElementById('newGroupOrders').value.trim();

      if (!name) {
        alert('Please enter a group name');
        return;
      }

      // Parse order numbers
      const orderNumbers = ordersText
        .split(/[,\n\s]+/)
        .map(s => s.trim())
        .filter(s => s.length > 0);

      try {
        // Create the group
        const response = await fetch('/api/tracking-groups', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, description })
        });
        const data = await response.json();

        if (data.success) {
          // If we have orders, add them to the group
          if (orderNumbers.length > 0) {
            await fetch(`/api/tracking-groups/${data.group_id}/orders`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ order_numbers: orderNumbers })
            });
          }

          closeCreateGroupModal();
          // Reload page to show new group tab
          window.location.href = '{{ url_for("check_shipments") }}?tab=group_' + data.group_id;
        } else {
          alert('Error creating group: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        alert('Error creating group: ' + err.message);
      }
    }

    // Load group orders on page load for active group tab
    document.addEventListener('DOMContentLoaded', function() {
      const activeGroupTab = document.querySelector('.tab-content.active[data-group-id]');
      if (activeGroupTab) {
        const groupId = activeGroupTab.dataset.groupId;
        loadGroupOrders(groupId);
      }
    });

    async function loadGroupOrders(groupId) {
      const tbody = document.getElementById(`groupOrdersBody_${groupId}`);
      if (!tbody) return;

      try {
        const response = await fetch(`/api/tracking-groups/${groupId}`);
        const data = await response.json();

        if (data.success) {
          renderGroupOrders(groupId, data.orders);
        } else {
          tbody.innerHTML = `<tr><td colspan="11" style="text-align: center; color: #c62828; padding: 40px;">Error: ${data.error}</td></tr>`;
        }
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="11" style="text-align: center; color: #c62828; padding: 40px;">Error loading: ${err.message}</td></tr>`;
      }
    }

    function renderGroupOrders(groupId, orders) {
      const tbody = document.getElementById(`groupOrdersBody_${groupId}`);
      if (!tbody) return;

      if (!orders || orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: #666; padding: 40px;">No orders in this group yet. Add some above!</td></tr>';
        return;
      }

      let html = '';
      orders.forEach(order => {
        const statusClass = order.tracking_status?.severity || 'ok';
        const statusText = order.tracking_status?.text || 'Unknown';

        // Format last activity date
        let lastActivity = order.last_activity || '';
        if (lastActivity && lastActivity.includes('T')) {
          const d = new Date(lastActivity);
          lastActivity = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
        }

        html += `
          <tr>
            <td style="text-align: center;">
              ${statusClass === 'ok' ? '<span style="color: #199b76; font-size: 1.2rem;">&#10003;</span>' :
                statusClass === 'warning' ? '<span style="color: #f57c00; font-size: 1.2rem;">&#9888;</span>' :
                statusClass === 'critical' ? '<span style="color: #c62828; font-size: 1.2rem;">&#10060;</span>' : ''}
            </td>
            <td>
              <a href="#" onclick="showOrderDetails('${order.order_number}'); return false;" class="customer-link">${order.order_number}</a>
            </td>
            <td>${order.batch_number || '-'}</td>
            <td>
              <a href="#" onclick="showOrderDetails('${order.order_number}'); return false;" class="customer-link">${order.customer_name || '-'}</a>
            </td>
            <td>${trackingLink(order.tracking_number, order.carrier || 'UPS')}</td>
            <td>${order.carrier || 'UPS'}</td>
            <td>${order.ship_date || '-'}</td>
            <td style="text-align: center;">${order.fulfillment_status === 'fulfilled' ? '<span style="color: #199b76;">&#10003;</span>' : '-'}</td>
            <td>
              <span class="status-badge ${statusClass}" style="white-space: nowrap;">
                ${statusText}
              </span>
            </td>
            <td style="font-size: 0.85rem;">${lastActivity || '-'}</td>
            <td>
              <button onclick="removeOrderFromGroup(${groupId}, '${order.order_number}')" class="btn-delete-small" style="font-size: 0.75rem; padding: 4px 8px;">
                &#10060; Remove
              </button>
            </td>
          </tr>
        `;
      });

      tbody.innerHTML = html;
    }

    async function addOrdersToGroup(groupId) {
      const input = document.getElementById(`addOrdersInput_${groupId}`).value.trim();
      if (!input) {
        alert('Please enter some order numbers');
        return;
      }

      // Parse order numbers
      const orderNumbers = input
        .split(/[,\n\s]+/)
        .map(s => s.trim())
        .filter(s => s.length > 0);

      const statusEl = document.getElementById(`addOrdersStatus_${groupId}`);
      statusEl.textContent = 'Adding...';

      try {
        const response = await fetch(`/api/tracking-groups/${groupId}/orders`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ order_numbers: orderNumbers })
        });
        const data = await response.json();

        if (data.success) {
          statusEl.textContent = data.message;
          statusEl.style.color = '#199b76';
          document.getElementById(`addOrdersInput_${groupId}`).value = '';
          // Refresh the group orders
          loadGroupOrders(groupId);
          setTimeout(() => { statusEl.textContent = ''; }, 3000);
        } else {
          statusEl.textContent = 'Error: ' + (data.error || 'Unknown error');
          statusEl.style.color = '#c62828';
        }
      } catch (err) {
        statusEl.textContent = 'Error: ' + err.message;
        statusEl.style.color = '#c62828';
      }
    }

    async function removeOrderFromGroup(groupId, orderNumber) {
      if (!confirm(`Remove order #${orderNumber} from this group?`)) return;

      try {
        const response = await fetch(`/api/tracking-groups/${groupId}/orders/${orderNumber}`, {
          method: 'DELETE'
        });
        const data = await response.json();

        if (data.success) {
          loadGroupOrders(groupId);
        } else {
          alert('Error removing order: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        alert('Error removing order: ' + err.message);
      }
    }

    async function deleteGroup(groupId, groupName) {
      if (!confirm(`Delete tracking group "${groupName}"? This cannot be undone.`)) return;

      try {
        const response = await fetch(`/api/tracking-groups/${groupId}`, {
          method: 'DELETE'
        });
        const data = await response.json();

        if (data.success) {
          window.location.href = '{{ url_for("check_shipments") }}?tab=shipments';
        } else {
          alert('Error deleting group: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        alert('Error deleting group: ' + err.message);
      }
    }

    async function editGroupName(groupId, currentName) {
      const newName = prompt('Enter new group name:', currentName);

      if (!newName || newName === currentName) return;

      try {
        const response = await fetch(`/api/tracking-groups/${groupId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: newName })
        });
        const data = await response.json();

        if (data.success) {
          // Reload page to update tab name
          window.location.reload();
        } else {
          alert('Error updating group: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        alert('Error updating group: ' + err.message);
      }
    }

    function refreshGroupTracking(groupId) {
      loadGroupOrders(groupId);
    }

    // Handle create group modal escape key
    document.getElementById('createGroupModal').addEventListener('click', function(e) {
      if (e.target === this) closeCreateGroupModal();
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // WebSocket-Based Live Tracking System
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    let socket = null;
    let reconnectAttempts = 0;
    const MAX_RECONNECT_ATTEMPTS = 10;

    // Collect all tracking numbers from the current page
    function getVisibleTrackingNumbers() {
      const trackingNumbers = [];
      const rows = document.querySelectorAll('#tab-shipments tbody tr');
      rows.forEach(row => {
        const trackingCell = row.querySelector('td:nth-child(5) a');
        if (trackingCell) {
          const tracking = trackingCell.textContent.trim();
          if (tracking && tracking !== '‚Äî') {
            trackingNumbers.push(tracking);
          }
        }
      });
      return trackingNumbers;
    }

    // Get tracking numbers that need refreshing (Loading, Checking, stale)
    function getStaleTrackingNumbers() {
      const staleTracking = [];
      const staleIndicators = ['Loading', 'Checking', 'Unknown', 'Error'];
      const rows = document.querySelectorAll('#tab-shipments tbody tr');

      rows.forEach(row => {
        const trackingCell = row.querySelector('td:nth-child(5) a');
        const statusCell = row.querySelector('td:nth-child(9)'); // Status is column 9

        if (trackingCell && statusCell) {
          const tracking = trackingCell.textContent.trim();
          const statusText = statusCell.textContent.trim();

          if (tracking && tracking !== '‚Äî') {
            // Check if status indicates stale data
            const isStale = staleIndicators.some(indicator =>
              statusText.toLowerCase().includes(indicator.toLowerCase())
            );
            if (isStale) {
              staleTracking.push(tracking);
            }
          }
        }
      });
      return staleTracking;
    }

    // Update a single tracking status in the table
    function updateTrackingRow(data) {
      const trackingNum = data.tracking_number;
      const rows = document.querySelectorAll('#tab-shipments tbody tr');

      rows.forEach(row => {
        const trackingCell = row.querySelector('td:nth-child(5) a');
        if (trackingCell && trackingCell.textContent.trim() === trackingNum) {
          // Update status badge
          const statusCell = row.querySelector('td:nth-child(9)');
          if (statusCell) {
            const badge = statusCell.querySelector('.status-badge');
            if (badge) {
              badge.className = 'status-badge status-' + data.status;
              badge.textContent = data.status_text;

              // Visual feedback for live update
              row.style.transition = 'background-color 0.5s';
              row.style.backgroundColor = '#e8f5e9';
              setTimeout(() => {
                row.style.backgroundColor = '';
              }, 2000);
            }
          }

          // Update last activity
          const activityCell = row.querySelector('td:nth-child(10)');
          if (activityCell && data.last_location) {
            activityCell.textContent = data.last_location;
          }
        }
      });
    }

    // Create/update connection status indicator
    function updateConnectionStatus(connected, message = '') {
      let indicator = document.getElementById('wsStatusIndicator');

      if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'wsStatusIndicator';
        indicator.style.cssText = `
          position: fixed;
          bottom: 20px;
          right: 20px;
          padding: 8px 14px;
          background: var(--bg-surface, #fff);
          border: 1px solid var(--border-color, #ddd);
          border-radius: 20px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          font-size: 0.8rem;
          z-index: 1000;
          display: flex;
          align-items: center;
          gap: 8px;
          transition: all 0.3s;
        `;
        document.body.appendChild(indicator);

        // Add pulse animation
        const style = document.createElement('style');
        style.textContent = `
          @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
          @keyframes spin { to { transform: rotate(360deg); } }
        `;
        document.head.appendChild(style);
      }

      if (connected) {
        indicator.innerHTML = `
          <span style="width: 8px; height: 8px; background: #4caf50; border-radius: 50%; animation: pulse 2s infinite;"></span>
          <span style="color: #4caf50;">Live</span>
        `;
        indicator.title = 'Real-time updates active';
      } else {
        indicator.innerHTML = `
          <span style="width: 10px; height: 10px; border: 2px solid #ff9800; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></span>
          <span style="color: #ff9800;">${message || 'Connecting...'}</span>
        `;
        indicator.title = message || 'Connecting to live updates';
      }
    }

    // Initialize WebSocket connection
    function initWebSocket() {
      // Load Socket.IO client dynamically
      if (typeof io === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdn.socket.io/4.7.2/socket.io.min.js';
        script.onload = connectWebSocket;
        document.head.appendChild(script);
      } else {
        connectWebSocket();
      }
    }

    function connectWebSocket() {
      updateConnectionStatus(false, 'Connecting...');

      socket = io({
        transports: ['websocket', 'polling'],
        reconnection: true,
        reconnectionDelay: 1000,
        reconnectionDelayMax: 10000,
        reconnectionAttempts: MAX_RECONNECT_ATTEMPTS,
        timeout: 20000
      });

      // Connection established
      socket.on('connect', () => {
        console.log('WebSocket connected');
        reconnectAttempts = 0;
        updateConnectionStatus(true);

        // Subscribe to shipments page updates
        socket.emit('subscribe_shipments_page');

        // Subscribe to visible tracking numbers
        const trackingNumbers = getVisibleTrackingNumbers();
        if (trackingNumbers.length > 0) {
          socket.emit('subscribe_tracking', { tracking_numbers: trackingNumbers });
        }

        // Auto-refresh stale/loading items
        const staleTracking = getStaleTrackingNumbers();
        if (staleTracking.length > 0) {
          console.log('Auto-refreshing', staleTracking.length, 'stale tracking numbers');
          socket.emit('request_tracking_refresh', {
            tracking_numbers: staleTracking.slice(0, 20)
          });
        }
      });

      // Connection lost
      socket.on('disconnect', (reason) => {
        console.log('WebSocket disconnected:', reason);
        updateConnectionStatus(false, 'Reconnecting...');
      });

      // Reconnection attempt
      socket.on('reconnect_attempt', (attempt) => {
        reconnectAttempts = attempt;
        updateConnectionStatus(false, `Reconnecting (${attempt}/${MAX_RECONNECT_ATTEMPTS})...`);
      });

      // Reconnection failed
      socket.on('reconnect_failed', () => {
        updateConnectionStatus(false, 'Connection lost');
        console.error('WebSocket reconnection failed');
      });

      // Receive tracking updates
      socket.on('tracking_update', (data) => {
        console.log('üì¶ Live tracking update:', data);
        updateTrackingRow(data);
      });

      // Refresh started confirmation
      socket.on('tracking_refresh_started', (data) => {
        console.log('üîÑ Refresh started:', data.count, 'tracking numbers being fetched');
      });

      // Subscription confirmed
      socket.on('subscription_confirmed', (data) => {
        console.log('‚úì Subscription confirmed:', data);
      });

      // Handle errors
      socket.on('error', (data) => {
        console.error('WebSocket error:', data);
      });

      // Rate limit warning
      socket.on('rate_limit_exceeded', (data) => {
        console.warn('Rate limit exceeded:', data);
      });
    }

    // Request manual refresh (triggers background API fetch)
    function requestTrackingRefresh() {
      if (!socket || !socket.connected) {
        alert('Not connected to live updates. Please refresh the page.');
        return;
      }

      const trackingNumbers = getVisibleTrackingNumbers();
      if (trackingNumbers.length === 0) return;

      socket.emit('request_tracking_refresh', {
        tracking_numbers: trackingNumbers.slice(0, 20)  // Limit to 20
      });

      updateConnectionStatus(true);
      console.log('Requested tracking refresh for', trackingNumbers.length, 'numbers');
    }

    // Initialize based on current tab
    document.addEventListener('DOMContentLoaded', function() {
      const currentTab = '{{ current_tab }}';

      if (currentTab === 'shipments') {
        initWebSocket();
      } else if (currentTab.startsWith('group_')) {
        // For tracking groups, also use WebSocket
        initWebSocket();
      }

      // Handle page visibility - reconnect when tab becomes visible
      document.addEventListener('visibilitychange', function() {
        if (!document.hidden && socket && !socket.connected) {
          socket.connect();
        }
      });
    });

    // Clean up on page unload
    window.addEventListener('beforeunload', function() {
      if (socket) {
        socket.disconnect();
      }
    });
  </script>
{% endblock %}
