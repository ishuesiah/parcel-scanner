{% extends "base.html" %}
{% from "macros.html" import tracking_link, flag_icon %}

{% block title %}Parcels Not Moving - H&O Parcel Scans{% endblock %}

{% block extra_styles %}
<style>
  .severity-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
    display: inline-block;
    white-space: nowrap;
  }
  .severity-badge.critical {
    background: #ffebee;
    color: #c62828;
  }
  .severity-badge.warning {
    background: #fff8e1;
    color: #f57c00;
  }
  .days-counter {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.9rem;
  }
  .days-counter.critical {
    background: #ffebee;
    color: #c62828;
  }
  .days-counter.warning {
    background: #fff8e1;
    color: #f57c00;
  }
  .summary-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 16px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .summary-card .icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4rem;
  }
  .summary-card .icon.warning { background: #fff8e1; }
  .summary-card .icon.critical { background: #ffebee; }
  .summary-card .count {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-main);
  }
  .summary-card .label {
    font-size: 0.85rem;
    color: var(--text-muted);
  }
  .filter-pills {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .filter-pill {
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.2s;
    border: 1px solid var(--border-color);
    background: var(--bg-surface);
    color: var(--text-muted);
  }
  .filter-pill:hover {
    border-color: var(--secondary);
    color: var(--secondary);
  }
  .filter-pill.active {
    background: var(--secondary);
    color: white;
    border-color: var(--secondary);
  }
  .table-row-critical {
    background: rgba(198, 40, 40, 0.03);
  }
  .table-row-critical:hover {
    background: rgba(198, 40, 40, 0.08) !important;
  }
  th.sortable {
    cursor: pointer;
  }
  th.sortable:hover {
    background: rgba(0, 0, 0, 0.05);
  }
  th.sortable a:hover {
    color: var(--secondary) !important;
  }
</style>
{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
  <div>
    <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
      <span style="font-size: 1.5rem;">&#128683;</span> Parcels Not Moving
    </h2>
    <p style="margin: 4px 0 0 0; color: var(--text-muted); font-size: 0.9rem;">
      Shipments with no tracking updates for {{ days_threshold }}+ days (still showing "Label Created")
    </p>
  </div>
  <div style="display: flex; gap: 8px;">
    <a href="{{ url_for('stationary_parcels', days=days_threshold, search=search_query, per_page=per_page, sort=sort_by, dir=sort_dir, refresh=1) }}"
       class="btn btn-primary" style="text-decoration: none;">
      &#x1F504; Refresh Tracking
    </a>
    <a href="{{ url_for('check_shipments', tab='shipments') }}" class="btn btn-secondary" style="text-decoration: none;">
      View All Shipments
    </a>
  </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div style="background: {% if category == 'error' %}#ffebee{% else %}#e8f5e9{% endif %}; border: 1px solid {% if category == 'error' %}#f44336{% else %}#4caf50{% endif %}; border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 1.2rem;">{% if category == 'error' %}&#9888;{% else %}&#128260;{% endif %}</span>
        <span>{{ message }}</span>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<!-- Summary Cards -->
<div style="display: flex; gap: 16px; margin-bottom: 24px; flex-wrap: wrap;">
  <div class="summary-card">
    <div class="icon warning">&#9888;</div>
    <div>
      <div class="count">{{ total_parcels }}</div>
      <div class="label">Total Stuck Parcels</div>
    </div>
  </div>
  <div class="summary-card">
    <div class="icon critical">&#128680;</div>
    <div>
      <div class="count">{{ parcels | selectattr('severity', 'equalto', 'critical') | list | length }}</div>
      <div class="label">Critical (14+ days)</div>
    </div>
  </div>
</div>

<!-- Filter and Search -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
  <div class="filter-pills">
    <a href="{{ url_for('stationary_parcels', days=10, search=search_query, per_page=per_page) }}"
       class="filter-pill {% if days_threshold == 10 %}active{% endif %}">10+ days</a>
    <a href="{{ url_for('stationary_parcels', days=14, search=search_query, per_page=per_page) }}"
       class="filter-pill {% if days_threshold == 14 %}active{% endif %}">14+ days</a>
    <a href="{{ url_for('stationary_parcels', days=21, search=search_query, per_page=per_page) }}"
       class="filter-pill {% if days_threshold == 21 %}active{% endif %}">21+ days</a>
    <a href="{{ url_for('stationary_parcels', days=30, search=search_query, per_page=per_page) }}"
       class="filter-pill {% if days_threshold == 30 %}active{% endif %}">30+ days</a>
  </div>

  <div class="search-box" style="margin: 0;">
    <form method="get" action="{{ url_for('stationary_parcels') }}" style="display: flex; gap: 8px;">
      <input type="hidden" name="days" value="{{ days_threshold }}">
      <input type="hidden" name="per_page" value="{{ per_page }}">
      <input type="text" name="search" placeholder="Search order #, customer, tracking..." value="{{ search_query }}" style="min-width: 260px;">
      <button type="submit" class="btn btn-search">Search</button>
      {% if search_query %}
        <a href="{{ url_for('stationary_parcels', days=days_threshold, per_page=per_page) }}" class="btn btn-secondary">Clear</a>
      {% endif %}
    </form>
  </div>
</div>

{% if parcels %}
  <table>
    <thead>
      <tr>
        <th style="width: 50px;">Flag</th>
        <th class="sortable">
          <a href="{{ url_for('stationary_parcels', days=days_threshold, search=search_query, per_page=per_page, sort='days', dir='desc' if sort_by == 'days' and sort_dir == 'asc' else 'asc') }}" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 4px;">
            Days Stuck
            {% if sort_by == 'days' %}
              <span style="font-size: 0.7rem;">{{ '▼' if sort_dir == 'desc' else '▲' }}</span>
            {% endif %}
          </a>
        </th>
        <th>Order #</th>
        <th class="sortable">
          <a href="{{ url_for('stationary_parcels', days=days_threshold, search=search_query, per_page=per_page, sort='customer', dir='desc' if sort_by == 'customer' and sort_dir == 'asc' else 'asc') }}" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 4px;">
            Customer
            {% if sort_by == 'customer' %}
              <span style="font-size: 0.7rem;">{{ '▼' if sort_dir == 'desc' else '▲' }}</span>
            {% endif %}
          </a>
        </th>
        <th>Tracking #</th>
        <th>Carrier</th>
        <th class="sortable">
          <a href="{{ url_for('stationary_parcels', days=days_threshold, search=search_query, per_page=per_page, sort='date', dir='desc' if sort_by == 'date' and sort_dir == 'asc' else 'asc') }}" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 4px;">
            Ship Date
            {% if sort_by == 'date' %}
              <span style="font-size: 0.7rem;">{{ '▼' if sort_dir == 'desc' else '▲' }}</span>
            {% endif %}
          </a>
        </th>
        <th>Scanned?</th>
        <th>Last Location</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for parcel in parcels %}
        <tr class="{% if parcel.severity == 'critical' %}table-row-critical{% endif %}" data-tracking="{{ parcel.tracking_number }}">
          <td style="text-align: center;">
            {% if parcel.severity == 'critical' %}
              <span class="flag-critical" title="{{ parcel.flag_text }}">&#128680;</span>
            {% else %}
              <span class="flag-warning" title="{{ parcel.flag_text }}">&#9888;</span>
            {% endif %}
          </td>
          <td>
            <span class="days-counter {{ parcel.severity }}">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
              </svg>
              {{ parcel.days_since_ship }} days
            </span>
          </td>
          <td>
            <a href="#" onclick="showOrderDetails('{{ parcel.order_number }}'); return false;" class="customer-link">
              {{ parcel.order_number }}
            </a>
          </td>
          <td>
            <a href="#" onclick="showOrderDetails('{{ parcel.order_number }}'); return false;" class="customer-link">
              {{ parcel.customer_name }}
            </a>
          </td>
          <td>{{ tracking_link(parcel.tracking_number, parcel.carrier) }}</td>
          <td>{{ parcel.carrier }}</td>
          <td>{{ parcel.ship_date }}</td>
          <td style="text-align: center;">
            {% if parcel.scanned %}
              <span style="color: #199b76;">&#10003; {{ parcel.scan_date }}</span>
            {% else %}
              <span style="color: #666;">&#8212;</span>
            {% endif %}
          </td>
          <td style="font-size: 0.85rem; color: var(--text-muted);">{{ parcel.last_location }}</td>
          <td>
            {% if parcel.tracking_url %}
              <a href="{{ parcel.tracking_url }}" target="_blank" rel="noopener" class="btn btn-search" style="font-size: 0.8rem; padding: 6px 10px;">
                Track
              </a>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Pagination -->
  <div class="pagination">
    <a href="{{ prev_url }}" class="{% if not has_prev %}disabled{% endif %}">&#8592; Prev</a>

    {% set show_pages = 5 %}
    {% set start_page = [1, page - show_pages // 2] | max %}
    {% set end_page = [total_pages, start_page + show_pages - 1] | min %}
    {% set start_page = [1, end_page - show_pages + 1] | max %}

    {% if start_page > 1 %}
      <a href="{{ url_for('stationary_parcels', page=1, search=search_query, per_page=per_page, days=days_threshold) }}">1</a>
      {% if start_page > 2 %}<span class="ellipsis">...</span>{% endif %}
    {% endif %}

    {% for p in range(start_page, end_page + 1) %}
      {% if p == page %}
        <a href="#" class="current-page">{{ p }}</a>
      {% else %}
        <a href="{{ url_for('stationary_parcels', page=p, search=search_query, per_page=per_page, days=days_threshold) }}">{{ p }}</a>
      {% endif %}
    {% endfor %}

    {% if end_page < total_pages %}
      {% if end_page < total_pages - 1 %}<span class="ellipsis">...</span>{% endif %}
      <a href="{{ url_for('stationary_parcels', page=total_pages, search=search_query, per_page=per_page, days=days_threshold) }}">{{ total_pages }}</a>
    {% endif %}

    <a href="{{ next_url }}" class="{% if not has_next %}disabled{% endif %}">Next &#8594;</a>

    <div class="per-page-select">
      <label>Show:</label>
      <select onchange="changePerPage(this.value)">
        <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
        <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
        <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
        <option value="500" {% if per_page == 500 %}selected{% endif %}>500</option>
      </select>
    </div>

    <span style="margin-left: 12px; color: #666;">({{ total_parcels }} total)</span>
  </div>
{% else %}
  <div style="text-align: center; padding: 60px 20px; background: var(--bg-surface); border-radius: 12px; border: 1px solid var(--border-color);">
    <div style="font-size: 3rem; margin-bottom: 16px;">&#127881;</div>
    <h3 style="margin: 0 0 8px 0; color: var(--text-main);">No Stuck Parcels Found</h3>
    <p style="margin: 0; color: var(--text-muted);">
      {% if search_query %}
        No parcels matching "{{ search_query }}" have been stuck for {{ days_threshold }}+ days.
      {% else %}
        Great news! No parcels have been stuck at "Label Created" for {{ days_threshold }}+ days.
      {% endif %}
    </p>
  </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  function changePerPage(value) {
    const url = new URL(window.location.href);
    url.searchParams.set('per_page', value);
    url.searchParams.set('page', '1');
    window.location.href = url.toString();
  }

  // Use the unified OrderPanel from base.html
  function showOrderDetails(orderNumber) {
    if (typeof OrderPanel !== 'undefined') {
      OrderPanel.open(orderNumber);
    } else {
      console.error('OrderPanel not loaded');
    }
  }

  // ─── Live Tracking Updates via WebSocket ───
  let socket = null;
  let totalParcelsCount = {{ total_parcels }};

  function initWebSocket() {
    socket = io({
      transports: ['websocket', 'polling'],
      reconnection: true,
      reconnectionDelay: 1000,
      reconnectionDelayMax: 10000,
      reconnectionAttempts: 10,
      timeout: 20000
    });

    socket.on('connect', () => {
      console.log('Connected to live tracking updates');
      updateConnectionIndicator(true);

      // Subscribe to shipments page updates (receives all tracking broadcasts)
      socket.emit('subscribe_shipments_page');

      // Also subscribe to specific tracking numbers on this page
      const trackingNumbers = getVisibleTrackingNumbers();
      if (trackingNumbers.length > 0) {
        socket.emit('subscribe_tracking', { tracking_numbers: trackingNumbers.slice(0, 50) });

        // AUTO-REFRESH on page load: Request fresh data for visible packages
        // This triggers backend to poll UPS/CP APIs and push updates via WebSocket
        console.log('Requesting tracking refresh for', trackingNumbers.length, 'packages...');
        socket.emit('request_tracking_refresh', { tracking_numbers: trackingNumbers.slice(0, 20) });
      }
    });

    socket.on('disconnect', () => {
      console.log('Disconnected from live tracking');
      updateConnectionIndicator(false);
    });

    // Handle live tracking updates
    socket.on('tracking_update', (data) => {
      console.log('Live tracking update:', data);
      handleTrackingUpdate(data);
    });

    socket.on('subscription_confirmed', (data) => {
      console.log('Subscription confirmed:', data);
    });
  }

  function getVisibleTrackingNumbers() {
    const rows = document.querySelectorAll('tbody tr[data-tracking]');
    return Array.from(rows).map(row => row.dataset.tracking).filter(t => t);
  }

  function handleTrackingUpdate(data) {
    const trackingNum = data.tracking_number;
    const status = data.status;
    const isDelivered = data.is_delivered;

    // Find the row for this tracking number
    const row = document.querySelector(`tr[data-tracking="${trackingNum}"]`);
    if (!row) return;

    // If package is now delivered or in_transit, remove it from "not moving" list
    if (status === 'delivered' || status === 'in_transit' || isDelivered) {
      // Animate removal
      row.style.transition = 'all 0.5s ease-out';
      row.style.backgroundColor = status === 'delivered' ? '#e8f5e9' : '#fff3e0';
      row.style.opacity = '0.7';

      setTimeout(() => {
        row.style.opacity = '0';
        row.style.transform = 'translateX(100px)';
      }, 1000);

      setTimeout(() => {
        row.remove();
        totalParcelsCount--;
        updateParcelCount();

        // Show notification
        showNotification(
          status === 'delivered'
            ? `Package ${trackingNum.slice(-8)} delivered!`
            : `Package ${trackingNum.slice(-8)} is now moving`
        );
      }, 1500);
    } else {
      // Update last location if changed
      const locationCell = row.querySelector('td:nth-child(9)');
      if (locationCell && data.last_location) {
        locationCell.textContent = data.last_location;
        // Flash to indicate update
        row.style.transition = 'background-color 0.3s';
        row.style.backgroundColor = '#e3f2fd';
        setTimeout(() => { row.style.backgroundColor = ''; }, 2000);
      }
    }
  }

  function updateParcelCount() {
    // Update the total count display
    const countSpan = document.querySelector('.pagination span[style*="margin-left"]');
    if (countSpan) {
      countSpan.textContent = `(${totalParcelsCount} total)`;
    }
    // Update summary card
    const summaryCount = document.querySelector('.summary-card .count');
    if (summaryCount) {
      summaryCount.textContent = totalParcelsCount;
    }
  }

  function showNotification(message) {
    const notif = document.createElement('div');
    notif.style.cssText = `
      position: fixed; bottom: 20px; right: 20px; background: #323232; color: white;
      padding: 12px 20px; border-radius: 8px; font-size: 0.9rem; z-index: 9999;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2); animation: slideIn 0.3s ease-out;
    `;
    notif.textContent = message;
    document.body.appendChild(notif);
    setTimeout(() => {
      notif.style.opacity = '0';
      notif.style.transition = 'opacity 0.3s';
      setTimeout(() => notif.remove(), 300);
    }, 4000);
  }

  function updateConnectionIndicator(connected) {
    let indicator = document.getElementById('liveIndicator');
    if (!indicator) {
      indicator = document.createElement('div');
      indicator.id = 'liveIndicator';
      indicator.style.cssText = `
        position: fixed; bottom: 20px; left: 20px; padding: 8px 14px;
        border-radius: 20px; font-size: 0.8rem; font-weight: 500;
        display: flex; align-items: center; gap: 6px; z-index: 9998;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      `;
      document.body.appendChild(indicator);
    }

    if (connected) {
      indicator.style.background = '#e8f5e9';
      indicator.style.color = '#2e7d32';
      indicator.innerHTML = '<span style="width:8px;height:8px;background:#4caf50;border-radius:50%;animation:pulse 2s infinite;"></span> Live updates';
    } else {
      indicator.style.background = '#ffebee';
      indicator.style.color = '#c62828';
      indicator.innerHTML = '<span style="width:8px;height:8px;background:#f44336;border-radius:50%;"></span> Disconnected';
    }
  }

  // Progressive refresh: request tracking updates in batches over time
  let refreshBatchIndex = 1; // Start at 1 since batch 0 is requested on connect
  function startProgressiveRefresh() {
    const allTracking = getVisibleTrackingNumbers();
    if (allTracking.length <= 20) return; // Already covered by initial request

    // Request next batch every 10 seconds (respects rate limits)
    const batchInterval = setInterval(() => {
      if (!socket || !socket.connected) return;

      const startIdx = refreshBatchIndex * 20;
      const batch = allTracking.slice(startIdx, startIdx + 20);

      if (batch.length === 0) {
        clearInterval(batchInterval);
        console.log('Progressive refresh complete - all packages queued');
        return;
      }

      console.log(`Requesting refresh batch ${refreshBatchIndex + 1}: ${batch.length} packages`);
      socket.emit('request_tracking_refresh', { tracking_numbers: batch });
      refreshBatchIndex++;
    }, 10000); // 10 seconds between batches
  }

  // Auto-refresh fallback: reload page if DB has new data
  function startAutoRefresh() {
    // Check for DB changes every 60 seconds
    setInterval(() => {
      if (totalParcelsCount > 0 && document.visibilityState === 'visible') {
        fetch(window.location.href, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
          .then(r => r.text())
          .then(html => {
            const match = html.match(/\((\d+) total\)/);
            if (match && parseInt(match[1]) !== totalParcelsCount) {
              showNotification('Updates available - refreshing...');
              setTimeout(() => window.location.reload(), 1500);
            }
          })
          .catch(() => {});
      }
    }, 60000); // 1 minute
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', () => {
    initWebSocket();
    startProgressiveRefresh();
    startAutoRefresh();
  });

  // Add CSS animation for pulse
  const style = document.createElement('style');
  style.textContent = `
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes slideIn { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  `;
  document.head.appendChild(style);
</script>
{% endblock %}
